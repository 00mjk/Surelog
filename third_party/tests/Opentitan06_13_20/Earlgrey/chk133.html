
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>hw/ip/prim_generic/rtl/prim_generic_flash.sv Cov: 99% </h3>
<pre style="margin:0; padding:0 ">// Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">// Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">// SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 ">//</pre>
<pre style="margin:0; padding:0 ">// prim flash module - Emulated using memory</pre>
<pre style="margin:0; padding:0 ">//</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">module prim_generic_flash #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  parameter int PagesPerBank = 256, // pages per bank</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  parameter int WordsPerPage = 256, // words per page</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  parameter int DataWidth   = 32,   // bits per word</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  parameter bit SkipInit = 1,       // this is an option to reset flash to all F's at reset</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Derived parameters</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int PageW = $clog2(PagesPerBank),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int WordW = $clog2(WordsPerPage),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int AddrW = PageW + WordW</pre>
<pre style="margin:0; padding:0 ">) (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input                        clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input                        rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input                        rd_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input                        prog_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input                        pg_erase_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input                        bk_erase_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input [AddrW-1:0]            addr_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input [DataWidth-1:0]        prog_data_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                 ack_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic [DataWidth-1:0] rd_data_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                 init_busy_o</pre>
<pre style="margin:0; padding:0 ">);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Emulated flash macro values</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int ReadCycles = 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int ProgCycles = 50;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int PgEraseCycles = 200;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int BkEraseCycles = 2000;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Locally derived values</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int WordsPerBank  = PagesPerBank * WordsPerPage;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  typedef enum logic [2:0] {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    StReset    = 'h0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    StInit     = 'h1,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    StIdle     = 'h2,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    StRead     = 'h3,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    StProg     = 'h4,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    StErase    = 'h5</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  } state_e;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  state_e st_q, st_d;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]              time_cnt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]              index_cnt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic                     time_cnt_inc ,time_cnt_clr, time_cnt_set1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic                     index_cnt_inc, index_cnt_clr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]              index_limit_q, index_limit_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]              time_limit_q, time_limit_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic                     prog_pend_q, prog_pend_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic                     mem_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic                     mem_wr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [AddrW-1:0]         mem_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [DataWidth-1:0]     held_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [DataWidth-1:0]     held_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [DataWidth-1:0]     mem_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic                     hold_cmd;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [AddrW-1:0]         held_addr;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // insert a fifo here to break the large fanout from inputs to memories on reads</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic rd_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [AddrW-1:0] addr_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_fifo_sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .Width  (AddrW),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .Pass   (0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .Depth  (2)</pre>
<pre id="id76" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) i_slice (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clr_i  (1'b0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wvalid (rd_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wready (),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wdata  (addr_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .depth  (),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rvalid (rd_q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rready (hold_cmd), //whenver command is held, pop</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rdata  (addr_q)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) st_q <= StReset;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    else st_q <= st_d;</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      held_addr <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      held_wdata <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else if (hold_cmd) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      held_addr <= rd_q ? addr_q : addr_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      held_wdata <= prog_data_i;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      time_limit_q  <= 32'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      index_limit_q <= 32'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      prog_pend_q   <= 1'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      time_limit_q  <= time_limit_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      index_limit_q <= index_limit_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      prog_pend_q   <= prog_pend_d;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // prog_pend_q is necessary to emulate flash behavior that a bit written to 0 cannot be written</pre>
<pre style="margin:0; padding:0 ">  // back to 1 without an erase</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      time_cnt <= 32'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      index_cnt <= 32'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      held_rdata <= 'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if (time_cnt_inc) time_cnt <= time_cnt + 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      else if (time_cnt_set1) time_cnt <= 32'h1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      else if (time_cnt_clr) time_cnt <= 32'h0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if (index_cnt_inc) index_cnt <= index_cnt + 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      else if (index_cnt_clr) index_cnt <= 32'h0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if (prog_pend_q) held_rdata <= rd_data_o;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="margin:0; padding:0 ">    // state</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    st_d             = st_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // internally consumed signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    index_limit_d    = index_limit_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    time_limit_d     = time_limit_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    prog_pend_d      = prog_pend_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mem_req          = 'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mem_wr           = 'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mem_addr         = 'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mem_wdata        = 'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    time_cnt_inc     = 1'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    time_cnt_clr     = 1'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    time_cnt_set1    = 1'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    index_cnt_inc    = 1'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    index_cnt_clr    = 1'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    hold_cmd         = 1'h0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // i/o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    init_busy_o      = 1'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    ack_o            = 1'h0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (st_q)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      StReset: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        init_busy_o = 1'h1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        st_d = StInit;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">      // Emulate flash power up to all 1's</pre>
<pre style="margin:0; padding:0 ">      // This implies this flash will not survive a reset</pre>
<pre style="margin:0; padding:0 ">      // Might need a different RESET for FPGA purposes</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      StInit: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        init_busy_o = 1'h1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (index_cnt < WordsPerBank && !SkipInit) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          st_d = StInit;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          index_cnt_inc = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_req = 1'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_wr  = 1'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_addr = index_cnt[AddrW-1:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_wdata = {DataWidth{1'b1}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          st_d = StIdle;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          index_cnt_clr = 1'b1;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      StIdle: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (rd_q) begin</pre>
<pre style="margin:0; padding:0 ">          // reads begin immediately</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          hold_cmd = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_addr = addr_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_req = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          time_cnt_inc = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          st_d = StRead;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else if (prog_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          hold_cmd = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          st_d = StRead;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          prog_pend_d = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else if (pg_erase_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          hold_cmd = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          st_d = StErase;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          index_limit_d = WordsPerPage;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          time_limit_d = PgEraseCycles;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else if (bk_erase_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          hold_cmd = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          st_d = StErase;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          index_limit_d = WordsPerBank;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          time_limit_d = BkEraseCycles;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      StRead: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        mem_addr = held_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (time_cnt < ReadCycles) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_req = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          time_cnt_inc = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else if (!prog_pend_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          ack_o = 1'b1; //finish up transaction</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">          // if another request already pending</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          if (rd_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            hold_cmd = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            mem_addr = addr_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            mem_req = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            time_cnt_set1 = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            st_d = StRead;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            time_cnt_clr = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            st_d = StIdle;</pre>
<pre style="margin:0; padding:0 ">          end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else if (prog_pend_q) begin</pre>
<pre style="margin:0; padding:0 ">          // this is the read performed before a program operation</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          prog_pend_d = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          time_cnt_clr = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          st_d = StProg;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      StProg: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        mem_addr = held_addr;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // if data is already 0, cannot program to 1 without erase</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        mem_wdata = held_wdata & held_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (time_cnt < ProgCycles) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_req = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_wr = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          time_cnt_inc = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          st_d = StIdle;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          ack_o  = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          time_cnt_clr = 1'b1;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      StErase: begin</pre>
<pre style="margin:0; padding:0 ">        // Actual erasing of the page</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (index_cnt < index_limit_q || time_cnt < time_limit_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_req = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_wr = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_wdata = {DataWidth{1'b1}};</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mem_addr = held_addr + index_cnt[AddrW-1:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          time_cnt_inc = (time_cnt < time_limit_q);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          index_cnt_inc = (index_cnt < index_limit_q);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          st_d = StIdle;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          ack_o = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          time_cnt_clr = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          index_cnt_clr = 1'b1;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        st_d = StIdle;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    endcase // unique case (st_q)</pre>
<pre style="margin:0; padding:0 ">  end // always_comb</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_ram_1p #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Width(DataWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Depth(WordsPerBank),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .DataBitsPerMask(DataWidth)</pre>
<pre id="id275" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) u_mem (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .req_i    (mem_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .write_i  (mem_wr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .addr_i   (mem_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wdata_i  (mem_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wmask_i  ({DataWidth{1'b1}}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rdata_o  (rd_data_o)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">endmodule // prim_generic_flash</pre>
<pre style="margin:0; padding:0 "></pre>
</body>
</html>
