
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>hw/vendor/lowrisc_ibex/rtl/ibex_cs_registers.sv Cov: 83% </h3>
<pre style="margin:0; padding:0 ">// Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">// Copyright 2018 ETH Zurich and University of Bologna, see also CREDITS.md.</pre>
<pre style="margin:0; padding:0 ">// Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">// SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">/**</pre>
<pre style="margin:0; padding:0 "> * Control and Status Registers</pre>
<pre style="margin:0; padding:0 "> *</pre>
<pre style="margin:0; padding:0 "> * Control and Status Registers (CSRs) following the RISC-V Privileged</pre>
<pre style="margin:0; padding:0 "> * Specification, draft version 1.11</pre>
<pre style="margin:0; padding:0 "> */</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">module ibex_cs_registers #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit          DbgTriggerEn     = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter int unsigned MHPMCounterNum   = 8,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter int unsigned MHPMCounterWidth = 40,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit          PMPEnable        = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter int unsigned PMPGranularity   = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter int unsigned PMPNumRegions    = 4,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit          RV32E            = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit          RV32M            = 0</pre>
<pre style="margin:0; padding:0 ">) (</pre>
<pre style="margin:0; padding:0 ">    // Clock and Reset</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Hart ID</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]          hart_id_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Privilege mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::priv_lvl_e  priv_mode_id_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::priv_lvl_e  priv_mode_if_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::priv_lvl_e  priv_mode_lsu_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 csr_mstatus_tw_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // mtvec</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]          csr_mtvec_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 csr_mtvec_init_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]          boot_addr_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Interface to registers (SRAM like)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 csr_access_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  ibex_pkg::csr_num_e   csr_addr_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]          csr_wdata_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  ibex_pkg::csr_op_e    csr_op_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]          csr_rdata_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // interrupts</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 irq_software_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 irq_timer_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 irq_external_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [14:0]          irq_fast_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 irq_pending_o,          // interupt request pending</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 nmi_mode_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 csr_msip_o,             // software interrupt pending</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 csr_mtip_o,             // timer interrupt pending</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 csr_meip_o,             // external interrupt pending</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [14:0]          csr_mfip_o,             // fast interrupt pending</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 csr_mstatus_mie_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]          csr_mepc_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // PMP</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::pmp_cfg_t   csr_pmp_cfg_o  [PMPNumRegions],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [33:0]          csr_pmp_addr_o [PMPNumRegions],</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // debug</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 debug_mode_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  ibex_pkg::dbg_cause_e debug_cause_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 debug_csr_save_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]          csr_depc_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 debug_single_step_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 debug_ebreakm_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 debug_ebreaku_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 trigger_match_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]          pc_if_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]          pc_id_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 csr_save_if_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 csr_save_id_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 csr_restore_mret_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 csr_restore_dret_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 csr_save_cause_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  ibex_pkg::exc_cause_e csr_mcause_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]          csr_mtval_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                 illegal_csr_insn_o,     // access to non-existent CSR,</pre>
<pre style="margin:0; padding:0 ">                                                         // with wrong priviledge level, or</pre>
<pre style="margin:0; padding:0 ">                                                         // missing write permissions</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 instr_new_id_i,         // ID stage sees a new instr</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Performance Counters</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 instr_ret_i,            // instr retired in ID/EX stage</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 instr_ret_compressed_i, // compressed instr retired</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 imiss_i,                // instr fetch</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 pc_set_i,               // PC was set to a new value</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 jump_i,                 // jump instr seen (j, jr, jal, jalr)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 branch_i,               // branch instr seen (bf, bnf)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 branch_taken_i,         // branch was taken</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 mem_load_i,             // load from memory in this cycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 mem_store_i,            // store to memory in this cycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                 lsu_busy_i</pre>
<pre style="margin:0; padding:0 ">);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  import ibex_pkg::*;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // misa</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam logic [1:0] MXL = 2'd1; // M-XLEN: XLEN in M-Mode for RV32</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam logic [31:0] MISA_VALUE =</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      (0          <<  0)  // A - Atomic Instructions extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (1          <<  2)  // C - Compressed extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (0          <<  3)  // D - Double precision floating-point extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (32'(RV32E) <<  4)  // E - RV32E base ISA</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (0          <<  5)  // F - Single precision floating-point extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (1          <<  8)  // I - RV32I/64I/128I base ISA</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (32'(RV32M) << 12)  // M - Integer Multiply/Divide extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (0          << 13)  // N - User level interrupts supported</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (0          << 18)  // S - Supervisor mode implemented</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (1          << 20)  // U - User mode implemented</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (0          << 23)  // X - Non-standard extensions present</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    | (32'(MXL)   << 30); // M-XLEN</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  typedef struct packed {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic      mie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic      mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    priv_lvl_e mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic      mprv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic      tw;</pre>
<pre id="id127" style="background-color: #FFB6C1; margin:0; padding:0 ">  } Status_t;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  typedef struct packed {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic      mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    priv_lvl_e mpp;</pre>
<pre id="id132" style="background-color: #FFB6C1; margin:0; padding:0 ">  } StatusStk_t;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // struct for mip/mie CSRs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  typedef struct packed {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic        irq_software;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic        irq_timer;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic        irq_external;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic [14:0] irq_fast; // 15 fast interrupts,</pre>
<pre style="margin:0; padding:0 ">                           // one interrupt is reserved for NMI (not visible through mip/mie)</pre>
<pre id="id141" style="background-color: #FFB6C1; margin:0; padding:0 ">  } Interrupts_t;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  typedef struct packed {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      x_debug_ver_e xdebugver;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic [11:0]  zero2;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         ebreakm;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         zero1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         ebreaks;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         ebreaku;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         stepie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         stopcount;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         stoptime;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      dbg_cause_e   cause;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         zero0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         mprven;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         nmip;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic         step;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      priv_lvl_e    prv;</pre>
<pre id="id159" style="background-color: #FFB6C1; margin:0; padding:0 ">  } Dcsr_t;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Interrupt and exception control signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] exception_pc;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // CSRs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  priv_lvl_e   priv_lvl_q, priv_lvl_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  Status_t     mstatus_q, mstatus_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  Interrupts_t mie_q, mie_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] mscratch_q, mscratch_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] mepc_q, mepc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic  [5:0] mcause_q, mcause_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] mtval_q, mtval_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] mtvec_q, mtvec_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  Interrupts_t mip;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  Dcsr_t       dcsr_q, dcsr_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] depc_q, depc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] dscratch0_q, dscratch0_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] dscratch1_q, dscratch1_d;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // CSRs for recoverable NMIs</pre>
<pre style="margin:0; padding:0 ">  // NOTE: these CSRS are nonstandard, see https://github.com/riscv/riscv-isa-manual/issues/261</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  StatusStk_t  mstack_q, mstack_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] mstack_epc_q, mstack_epc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic  [5:0] mstack_cause_q, mstack_cause_d;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // PMP Signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]                 pmp_addr_rdata  [PMP_MAX_REGIONS];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [PMP_CFG_W-1:0]        pmp_cfg_rdata   [PMP_MAX_REGIONS];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Hardware performance monitor signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]                 mcountinhibit;</pre>
<pre style="margin:0; padding:0 ">  // Only have mcountinhibit flops for counters that actually exist</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [MHPMCounterNum+3-1:0] mcountinhibit_d, mcountinhibit_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic                        mcountinhibit_we;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [63:0] mhpmcounter_d [32];</pre>
<pre style="margin:0; padding:0 ">  // mhpmcounter flops are elaborated below providing only the precise number that is required based</pre>
<pre style="margin:0; padding:0 ">  // on MHPMCounterNum/MHPMCounterWidth. This signal connects to the Q output of these flops</pre>
<pre style="margin:0; padding:0 ">  // where they exist and is otherwise 0.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [63:0] mhpmcounter [32];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] mhpmcounter_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] mhpmcounterh_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] mhpmcounter_incr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] mhpmevent [32];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic  [4:0] mhpmcounter_idx;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Debug / trigger registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] tselect_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] tmatch_control_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] tmatch_value_rdata;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // CSR update logic</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] csr_wdata_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] csr_rdata_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        csr_we_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        csr_wreq;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Access violation signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        illegal_csr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        illegal_csr_priv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        illegal_csr_write;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [7:0]  unused_boot_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [2:0]  unused_csr_addr;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign unused_boot_addr = boot_addr_i[7:0];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="margin:0; padding:0 ">  // CSR reg //</pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [$bits(csr_num_e)-1:0] csr_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_addr           = {csr_addr_i};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign unused_csr_addr    = csr_addr[7:5];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign mhpmcounter_idx    = csr_addr[4:0];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // See RISC-V Privileged Specification, version 1.11, Section 2.1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign illegal_csr_priv   = (csr_addr[9:8] > {priv_lvl_q});</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign illegal_csr_write  = (csr_addr[11:10] == 2'b11) && csr_wreq;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign illegal_csr_insn_o = csr_access_i & (illegal_csr | illegal_csr_write | illegal_csr_priv);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // mip CSR is purely combinational - must be able to re-enable the clock upon WFI</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign mip.irq_software = irq_software_i & mie_q.irq_software;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign mip.irq_timer    = irq_timer_i    & mie_q.irq_timer;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign mip.irq_external = irq_external_i & mie_q.irq_external;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign mip.irq_fast     = irq_fast_i     & mie_q.irq_fast;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // read logic</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    csr_rdata_int = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    illegal_csr   = 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (csr_addr_i)</pre>
<pre style="margin:0; padding:0 ">      // mhartid: unique hardware thread id</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHARTID: csr_rdata_int = hart_id_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // mstatus: always M-mode, contains IE bit</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MSTATUS: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int                                                   = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MSTATUS_MIE_BIT]                              = mstatus_q.mie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MSTATUS_MPIE_BIT]                             = mstatus_q.mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MSTATUS_MPP_BIT_HIGH:CSR_MSTATUS_MPP_BIT_LOW] = mstatus_q.mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MSTATUS_MPRV_BIT]                             = mstatus_q.mprv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MSTATUS_TW_BIT]                               = mstatus_q.tw;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // misa</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MISA: csr_rdata_int = MISA_VALUE;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // interrupt enable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MIE: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int                                     = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MSIX_BIT]                       = mie_q.irq_software;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MTIX_BIT]                       = mie_q.irq_timer;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MEIX_BIT]                       = mie_q.irq_external;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MFIX_BIT_HIGH:CSR_MFIX_BIT_LOW] = mie_q.irq_fast;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MSCRATCH: csr_rdata_int = mscratch_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // mtvec: trap-vector base address</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MTVEC: csr_rdata_int = mtvec_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // mepc: exception program counter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MEPC: csr_rdata_int = mepc_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // mcause: exception cause</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MCAUSE: csr_rdata_int = {mcause_q[5], 26'b0, mcause_q[4:0]};</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // mtval: trap value</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MTVAL: csr_rdata_int = mtval_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // mip: interrupt pending</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MIP: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int                                     = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MSIX_BIT]                       = mip.irq_software;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MTIX_BIT]                       = mip.irq_timer;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MEIX_BIT]                       = mip.irq_external;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int[CSR_MFIX_BIT_HIGH:CSR_MFIX_BIT_LOW] = mip.irq_fast;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // PMP registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPCFG0:   csr_rdata_int = {pmp_cfg_rdata[3],  pmp_cfg_rdata[2],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                      pmp_cfg_rdata[1],  pmp_cfg_rdata[0]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPCFG1:   csr_rdata_int = {pmp_cfg_rdata[7],  pmp_cfg_rdata[6],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                      pmp_cfg_rdata[5],  pmp_cfg_rdata[4]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPCFG2:   csr_rdata_int = {pmp_cfg_rdata[11], pmp_cfg_rdata[10],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                      pmp_cfg_rdata[9],  pmp_cfg_rdata[8]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPCFG3:   csr_rdata_int = {pmp_cfg_rdata[15], pmp_cfg_rdata[14],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                      pmp_cfg_rdata[13], pmp_cfg_rdata[12]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR0:  csr_rdata_int = pmp_addr_rdata[0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR1:  csr_rdata_int = pmp_addr_rdata[1];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR2:  csr_rdata_int = pmp_addr_rdata[2];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR3:  csr_rdata_int = pmp_addr_rdata[3];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR4:  csr_rdata_int = pmp_addr_rdata[4];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR5:  csr_rdata_int = pmp_addr_rdata[5];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR6:  csr_rdata_int = pmp_addr_rdata[6];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR7:  csr_rdata_int = pmp_addr_rdata[7];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR8:  csr_rdata_int = pmp_addr_rdata[8];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR9:  csr_rdata_int = pmp_addr_rdata[9];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR10: csr_rdata_int = pmp_addr_rdata[10];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR11: csr_rdata_int = pmp_addr_rdata[11];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR12: csr_rdata_int = pmp_addr_rdata[12];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR13: csr_rdata_int = pmp_addr_rdata[13];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR14: csr_rdata_int = pmp_addr_rdata[14];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_PMPADDR15: csr_rdata_int = pmp_addr_rdata[15];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_DCSR: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = dcsr_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr = ~debug_mode_i;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_DPC: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = depc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr = ~debug_mode_i;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_DSCRATCH0: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = dscratch0_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr = ~debug_mode_i;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_DSCRATCH1: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = dscratch1_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr = ~debug_mode_i;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // machine counter/timers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MCOUNTINHIBIT: csr_rdata_int = mcountinhibit;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMEVENT3,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMEVENT4,  CSR_MHPMEVENT5,  CSR_MHPMEVENT6,  CSR_MHPMEVENT7,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMEVENT8,  CSR_MHPMEVENT9,  CSR_MHPMEVENT10, CSR_MHPMEVENT11,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMEVENT12, CSR_MHPMEVENT13, CSR_MHPMEVENT14, CSR_MHPMEVENT15,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMEVENT16, CSR_MHPMEVENT17, CSR_MHPMEVENT18, CSR_MHPMEVENT19,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMEVENT20, CSR_MHPMEVENT21, CSR_MHPMEVENT22, CSR_MHPMEVENT23,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMEVENT24, CSR_MHPMEVENT25, CSR_MHPMEVENT26, CSR_MHPMEVENT27,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMEVENT28, CSR_MHPMEVENT29, CSR_MHPMEVENT30, CSR_MHPMEVENT31: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = mhpmevent[mhpmcounter_idx];</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MCYCLE,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MINSTRET,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER3,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER4,  CSR_MHPMCOUNTER5,  CSR_MHPMCOUNTER6,  CSR_MHPMCOUNTER7,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER8,  CSR_MHPMCOUNTER9,  CSR_MHPMCOUNTER10, CSR_MHPMCOUNTER11,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER12, CSR_MHPMCOUNTER13, CSR_MHPMCOUNTER14, CSR_MHPMCOUNTER15,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER16, CSR_MHPMCOUNTER17, CSR_MHPMCOUNTER18, CSR_MHPMCOUNTER19,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER20, CSR_MHPMCOUNTER21, CSR_MHPMCOUNTER22, CSR_MHPMCOUNTER23,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER24, CSR_MHPMCOUNTER25, CSR_MHPMCOUNTER26, CSR_MHPMCOUNTER27,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER28, CSR_MHPMCOUNTER29, CSR_MHPMCOUNTER30, CSR_MHPMCOUNTER31: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = mhpmcounter[mhpmcounter_idx][31:0];</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MCYCLEH,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MINSTRETH,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER3H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER4H,  CSR_MHPMCOUNTER5H,  CSR_MHPMCOUNTER6H,  CSR_MHPMCOUNTER7H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER8H,  CSR_MHPMCOUNTER9H,  CSR_MHPMCOUNTER10H, CSR_MHPMCOUNTER11H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER12H, CSR_MHPMCOUNTER13H, CSR_MHPMCOUNTER14H, CSR_MHPMCOUNTER15H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER16H, CSR_MHPMCOUNTER17H, CSR_MHPMCOUNTER18H, CSR_MHPMCOUNTER19H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER20H, CSR_MHPMCOUNTER21H, CSR_MHPMCOUNTER22H, CSR_MHPMCOUNTER23H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER24H, CSR_MHPMCOUNTER25H, CSR_MHPMCOUNTER26H, CSR_MHPMCOUNTER27H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MHPMCOUNTER28H, CSR_MHPMCOUNTER29H, CSR_MHPMCOUNTER30H, CSR_MHPMCOUNTER31H: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = mhpmcounter[mhpmcounter_idx][63:32];</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // Debug triggers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_TSELECT: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = tselect_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_TDATA1: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = tmatch_control_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_TDATA2: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = tmatch_value_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_TDATA3: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_MCONTEXT: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_SCONTEXT: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_rdata_int = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        illegal_csr = 1'b1;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    endcase</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // write logic</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    exception_pc = pc_id_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    priv_lvl_d   = priv_lvl_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mstatus_d    = mstatus_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mie_d        = mie_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mscratch_d   = mscratch_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mepc_d       = mepc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mcause_d     = mcause_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mtval_d      = mtval_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mtvec_d      = csr_mtvec_init_i ? {boot_addr_i[31:8], 6'b0, 2'b01} : mtvec_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    dcsr_d       = dcsr_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    depc_d       = depc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    dscratch0_d  = dscratch0_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    dscratch1_d  = dscratch1_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mstack_d       = mstack_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mstack_epc_d   = mstack_epc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mstack_cause_d = mstack_cause_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mcountinhibit_we = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_we   = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounterh_we  = '0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (csr_we_int) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      unique case (csr_addr_i)</pre>
<pre style="margin:0; padding:0 ">        // mstatus: IE bit</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MSTATUS: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstatus_d = '{</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              mie:  csr_wdata_int[CSR_MSTATUS_MIE_BIT],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              mpie: csr_wdata_int[CSR_MSTATUS_MPIE_BIT],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              mpp:  priv_lvl_e'(csr_wdata_int[CSR_MSTATUS_MPP_BIT_HIGH:CSR_MSTATUS_MPP_BIT_LOW]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              mprv: csr_wdata_int[CSR_MSTATUS_MPRV_BIT],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              tw:   csr_wdata_int[CSR_MSTATUS_TW_BIT]</pre>
<pre style="margin:0; padding:0 ">          };</pre>
<pre style="margin:0; padding:0 ">          // Convert illegal values to M-mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          if ((mstatus_d.mpp != PRIV_LVL_M) && (mstatus_d.mpp != PRIV_LVL_U)) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            mstatus_d.mpp = PRIV_LVL_M;</pre>
<pre style="margin:0; padding:0 ">          end</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // interrupt enable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MIE: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mie_d.irq_software = csr_wdata_int[CSR_MSIX_BIT];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mie_d.irq_timer    = csr_wdata_int[CSR_MTIX_BIT];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mie_d.irq_external = csr_wdata_int[CSR_MEIX_BIT];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mie_d.irq_fast     = csr_wdata_int[CSR_MFIX_BIT_HIGH:CSR_MFIX_BIT_LOW];</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MSCRATCH: mscratch_d = csr_wdata_int;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // mepc: exception program counter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MEPC: mepc_d = {csr_wdata_int[31:1], 1'b0};</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // mcause</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MCAUSE: mcause_d = {csr_wdata_int[31], csr_wdata_int[4:0]};</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // mtval: trap value</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MTVAL: mtval_d = csr_wdata_int;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // mtvec</pre>
<pre style="margin:0; padding:0 ">        // mtvec.MODE set to vectored</pre>
<pre style="margin:0; padding:0 ">        // mtvec.BASE must be 256-byte aligned</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MTVEC: mtvec_d = {csr_wdata_int[31:8], 6'b0, 2'b01};</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_DCSR: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d = csr_wdata_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.xdebugver = XDEBUGVER_STD;</pre>
<pre style="margin:0; padding:0 ">          // Change to PRIV_LVL_M if software writes an unsupported value</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          if ((dcsr_d.prv != PRIV_LVL_M) && (dcsr_d.prv != PRIV_LVL_U)) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            dcsr_d.prv = PRIV_LVL_M;</pre>
<pre style="margin:0; padding:0 ">          end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">          // currently not supported:</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.nmip = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.mprven = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.stopcount = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.stoptime = 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">          // forced to be zero</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.zero0 = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.zero1 = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.zero2 = 12'h0;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // dpc: debug program counter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_DPC: depc_d = {csr_wdata_int[31:1], 1'b0};</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_DSCRATCH0: dscratch0_d = csr_wdata_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_DSCRATCH1: dscratch1_d = csr_wdata_int;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // machine counter/timers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MCOUNTINHIBIT: mcountinhibit_we = 1'b1;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MCYCLE,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MINSTRET,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER3,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER4,  CSR_MHPMCOUNTER5,  CSR_MHPMCOUNTER6,  CSR_MHPMCOUNTER7,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER8,  CSR_MHPMCOUNTER9,  CSR_MHPMCOUNTER10, CSR_MHPMCOUNTER11,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER12, CSR_MHPMCOUNTER13, CSR_MHPMCOUNTER14, CSR_MHPMCOUNTER15,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER16, CSR_MHPMCOUNTER17, CSR_MHPMCOUNTER18, CSR_MHPMCOUNTER19,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER20, CSR_MHPMCOUNTER21, CSR_MHPMCOUNTER22, CSR_MHPMCOUNTER23,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER24, CSR_MHPMCOUNTER25, CSR_MHPMCOUNTER26, CSR_MHPMCOUNTER27,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER28, CSR_MHPMCOUNTER29, CSR_MHPMCOUNTER30, CSR_MHPMCOUNTER31: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mhpmcounter_we[mhpmcounter_idx] = 1'b1;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MCYCLEH,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MINSTRETH,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER3H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER4H,  CSR_MHPMCOUNTER5H,  CSR_MHPMCOUNTER6H,  CSR_MHPMCOUNTER7H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER8H,  CSR_MHPMCOUNTER9H,  CSR_MHPMCOUNTER10H, CSR_MHPMCOUNTER11H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER12H, CSR_MHPMCOUNTER13H, CSR_MHPMCOUNTER14H, CSR_MHPMCOUNTER15H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER16H, CSR_MHPMCOUNTER17H, CSR_MHPMCOUNTER18H, CSR_MHPMCOUNTER19H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER20H, CSR_MHPMCOUNTER21H, CSR_MHPMCOUNTER22H, CSR_MHPMCOUNTER23H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER24H, CSR_MHPMCOUNTER25H, CSR_MHPMCOUNTER26H, CSR_MHPMCOUNTER27H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        CSR_MHPMCOUNTER28H, CSR_MHPMCOUNTER29H, CSR_MHPMCOUNTER30H, CSR_MHPMCOUNTER31H: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mhpmcounterh_we[mhpmcounter_idx] = 1'b1;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        default:;</pre>
<pre style="margin:0; padding:0 ">      endcase</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // exception controller gets priority over other writes</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (1'b1)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      csr_save_cause_i: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        unique case (1'b1)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          csr_save_if_i: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            exception_pc = pc_if_i;</pre>
<pre style="margin:0; padding:0 ">          end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          csr_save_id_i: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            exception_pc = pc_id_i;</pre>
<pre style="margin:0; padding:0 ">          end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          default:;</pre>
<pre style="margin:0; padding:0 ">        endcase</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // Any exception, including debug mode, causes a switch to M-mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        priv_lvl_d = PRIV_LVL_M;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (debug_csr_save_i) begin</pre>
<pre style="margin:0; padding:0 ">          // all interrupts are masked</pre>
<pre style="margin:0; padding:0 ">          // do not update cause, epc, tval, epc and status</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.prv   = priv_lvl_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          dcsr_d.cause = debug_cause_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          depc_d       = exception_pc;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else if (!debug_mode_i) begin</pre>
<pre style="margin:0; padding:0 ">          // In debug mode, "exceptions do not update any registers. That</pre>
<pre style="margin:0; padding:0 ">          // includes cause, epc, tval, dpc and mstatus." [Debug Spec v0.13.2, p.39]</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mtval_d        = csr_mtval_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstatus_d.mie  = 1'b0; // disable interrupts</pre>
<pre style="margin:0; padding:0 ">          // save current status</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstatus_d.mpie = mstatus_q.mie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstatus_d.mpp  = priv_lvl_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mepc_d         = exception_pc;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mcause_d       = {csr_mcause_i};</pre>
<pre style="margin:0; padding:0 ">          // save previous status for recoverable NMI</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstack_d.mpie  = mstatus_q.mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstack_d.mpp   = mstatus_q.mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstack_epc_d   = mepc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstack_cause_d = mcause_q;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end // csr_save_cause_i</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      csr_restore_dret_i: begin // DRET</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        priv_lvl_d = dcsr_q.prv;</pre>
<pre style="margin:0; padding:0 ">      end // csr_restore_dret_i</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      csr_restore_mret_i: begin // MRET</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        priv_lvl_d     = mstatus_q.mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        mstatus_d.mie  = mstatus_q.mpie; // re-enable interrupts</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (nmi_mode_i) begin</pre>
<pre style="margin:0; padding:0 ">          // when returning from an NMI restore state from mstack CSR</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstatus_d.mpie = mstack_q.mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstatus_d.mpp  = mstack_q.mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mepc_d         = mstack_epc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mcause_d       = mstack_cause_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="margin:0; padding:0 ">          // otherwise just set mstatus.MPIE/MPP</pre>
<pre style="margin:0; padding:0 ">          // See RISC-V Privileged Specification, version 1.11, Section 3.1.6.1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstatus_d.mpie = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mstatus_d.mpp  = PRIV_LVL_U;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end // csr_restore_mret_i</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default:;</pre>
<pre style="margin:0; padding:0 ">    endcase</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // CSR operation logic</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    csr_wreq = 1'b1;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (csr_op_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_OP_WRITE: csr_wdata_int =  csr_wdata_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_OP_SET:   csr_wdata_int =  csr_wdata_i | csr_rdata_o;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_OP_CLEAR: csr_wdata_int = ~csr_wdata_i & csr_rdata_o;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      CSR_OP_READ: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_wdata_int = csr_wdata_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_wreq      = 1'b0;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_wdata_int = csr_wdata_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_wreq      = 1'b0;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    endcase</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // only write CSRs during one clock cycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_we_int  = csr_wreq & ~illegal_csr_insn_o & instr_new_id_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_rdata_o = csr_rdata_int;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // directly output some registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_msip_o  = mip.irq_software;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_mtip_o  = mip.irq_timer;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_meip_o  = mip.irq_external;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_mfip_o  = mip.irq_fast;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_mepc_o  = mepc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_depc_o  = depc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_mtvec_o = mtvec_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_mstatus_mie_o   = mstatus_q.mie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_mstatus_tw_o    = mstatus_q.tw;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign debug_single_step_o = dcsr_q.step;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign debug_ebreakm_o     = dcsr_q.ebreakm;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign debug_ebreaku_o     = dcsr_q.ebreaku;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign irq_pending_o = csr_msip_o | csr_mtip_o | csr_meip_o | (|csr_mfip_o);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // actual registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      priv_lvl_q     <= PRIV_LVL_M;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mstatus_q      <= '{</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mie:  1'b0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mpie: 1'b1,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mpp:  PRIV_LVL_U,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mprv: 1'b0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          tw:   1'b0</pre>
<pre style="margin:0; padding:0 ">      };</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mie_q          <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mscratch_q     <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mepc_q         <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mcause_q       <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mtval_q        <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mtvec_q        <= 32'b01;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      dcsr_q         <= '{</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          xdebugver: XDEBUGVER_STD,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          cause:     DBG_CAUSE_NONE, // 3'h0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          prv:       PRIV_LVL_M,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          default:   '0</pre>
<pre style="margin:0; padding:0 ">      };</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      depc_q         <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      dscratch0_q    <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      dscratch1_q    <= '0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mstack_q       <= '{</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mpie: 1'b1,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mpp:  PRIV_LVL_U</pre>
<pre style="margin:0; padding:0 ">      };</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mstack_epc_q   <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mstack_cause_q <= '0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="margin:0; padding:0 ">      // update CSRs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      priv_lvl_q     <= priv_lvl_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mstatus_q      <= mstatus_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mie_q          <= mie_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mscratch_q     <= mscratch_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mepc_q         <= mepc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mcause_q       <= mcause_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mtval_q        <= mtval_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mtvec_q        <= mtvec_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      dcsr_q         <= dcsr_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      depc_q         <= depc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      dscratch0_q    <= dscratch0_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      dscratch1_q    <= dscratch1_d;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mstack_q       <= mstack_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mstack_epc_q   <= mstack_epc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mstack_cause_q <= mstack_cause_d;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Send current priv level to the decoder</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign priv_mode_id_o = priv_lvl_q;</pre>
<pre style="margin:0; padding:0 ">  // New instruction fetches need to account for updates to priv_lvl_q this cycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign priv_mode_if_o = priv_lvl_d;</pre>
<pre style="margin:0; padding:0 ">  // Load/store instructions must factor in MPRV for PMP checking</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign priv_mode_lsu_o = mstatus_q.mprv ? mstatus_q.mpp : priv_lvl_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // -----------------</pre>
<pre style="margin:0; padding:0 ">  // PMP registers</pre>
<pre style="margin:0; padding:0 ">  // -----------------</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id716" style="background-color: #FFB6C1; margin:0; padding:0 ">  if (PMPEnable) begin : g_pmp_registers</pre>
<pre id="id717" style="background-color: #FFB6C1; margin:0; padding:0 ">    pmp_cfg_t                    pmp_cfg         [PMPNumRegions];</pre>
<pre id="id718" style="background-color: #FFB6C1; margin:0; padding:0 ">    pmp_cfg_t                    pmp_cfg_wdata   [PMPNumRegions];</pre>
<pre id="id719" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic [31:0]                 pmp_addr        [PMPNumRegions];</pre>
<pre id="id720" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic [PMPNumRegions-1:0]    pmp_cfg_we;</pre>
<pre id="id721" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic [PMPNumRegions-1:0]    pmp_addr_we;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Expanded / qualified register read data</pre>
<pre id="id724" style="background-color: #FFB6C1; margin:0; padding:0 ">    for (genvar i = 0; i < PMP_MAX_REGIONS; i++) begin : g_exp_rd_data</pre>
<pre id="id725" style="background-color: #FFB6C1; margin:0; padding:0 ">      if (i < PMPNumRegions) begin : g_implemented_regions</pre>
<pre style="margin:0; padding:0 ">        // Add in zero padding for reserved fields</pre>
<pre id="id727" style="background-color: #FFB6C1; margin:0; padding:0 ">        assign pmp_cfg_rdata[i] = {pmp_cfg[i].lock, 2'b00, pmp_cfg[i].mode,</pre>
<pre id="id728" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   pmp_cfg[i].exec, pmp_cfg[i].write, pmp_cfg[i].read};</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // Address field read data depends on the current programmed mode and the granularity</pre>
<pre style="margin:0; padding:0 ">        // See RISC-V Privileged Specification, version 1.11, Section 3.6.1</pre>
<pre id="id732" style="background-color: #FFB6C1; margin:0; padding:0 ">        if (PMPGranularity == 0) begin : g_pmp_g0</pre>
<pre style="margin:0; padding:0 ">          // If G == 0, read data is unmodified</pre>
<pre id="id734" style="background-color: #FFB6C1; margin:0; padding:0 ">          assign pmp_addr_rdata[i] = pmp_addr[i];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id736" style="background-color: #FFB6C1; margin:0; padding:0 ">        end else if (PMPGranularity == 1) begin : g_pmp_g1</pre>
<pre style="margin:0; padding:0 ">          // If G == 1, bit [G-1] reads as zero in TOR or OFF mode</pre>
<pre id="id738" style="background-color: #FFB6C1; margin:0; padding:0 ">          always_comb begin</pre>
<pre id="id739" style="background-color: #FFB6C1; margin:0; padding:0 ">            pmp_addr_rdata[i] = pmp_addr[i];</pre>
<pre id="id740" style="background-color: #FFB6C1; margin:0; padding:0 ">            if ((pmp_cfg[i].mode == PMP_MODE_OFF) || (pmp_cfg[i].mode == PMP_MODE_TOR)) begin</pre>
<pre id="id741" style="background-color: #FFB6C1; margin:0; padding:0 ">              pmp_addr_rdata[i][PMPGranularity-1:0] = '0;</pre>
<pre style="margin:0; padding:0 ">            end</pre>
<pre style="margin:0; padding:0 ">          end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id745" style="background-color: #FFB6C1; margin:0; padding:0 ">        end else begin : g_pmp_g2</pre>
<pre style="margin:0; padding:0 ">          // For G >= 2, bits are masked to one or zero depending on the mode</pre>
<pre id="id747" style="background-color: #FFB6C1; margin:0; padding:0 ">          always_comb begin</pre>
<pre id="id748" style="background-color: #FFB6C1; margin:0; padding:0 ">            pmp_addr_rdata[i] = pmp_addr[i];</pre>
<pre id="id749" style="background-color: #FFB6C1; margin:0; padding:0 ">            if ((pmp_cfg[i].mode == PMP_MODE_OFF) || (pmp_cfg[i].mode == PMP_MODE_TOR)) begin</pre>
<pre style="margin:0; padding:0 ">              // In TOR or OFF mode, bits [G-1:0] must read as zero</pre>
<pre id="id751" style="background-color: #FFB6C1; margin:0; padding:0 ">              pmp_addr_rdata[i][PMPGranularity-1:0] = '0;</pre>
<pre id="id752" style="background-color: #FFB6C1; margin:0; padding:0 ">            end else if (pmp_cfg[i].mode == PMP_MODE_NAPOT) begin</pre>
<pre style="margin:0; padding:0 ">              // In NAPOT mode, bits [G-2:0] must read as one</pre>
<pre id="id754" style="background-color: #FFB6C1; margin:0; padding:0 ">              pmp_addr_rdata[i][PMPGranularity-2:0] = '1;</pre>
<pre style="margin:0; padding:0 ">            end</pre>
<pre style="margin:0; padding:0 ">          end</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id759" style="background-color: #FFB6C1; margin:0; padding:0 ">      end else begin : g_other_regions</pre>
<pre style="margin:0; padding:0 ">        // Non-implemented regions read as zero</pre>
<pre id="id761" style="background-color: #FFB6C1; margin:0; padding:0 ">        assign pmp_cfg_rdata[i]  = '0;</pre>
<pre id="id762" style="background-color: #FFB6C1; margin:0; padding:0 ">        assign pmp_addr_rdata[i] = '0;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Write data calculation</pre>
<pre id="id767" style="background-color: #FFB6C1; margin:0; padding:0 ">    for (genvar i = 0; i < PMPNumRegions; i++) begin : g_pmp_csrs</pre>
<pre style="margin:0; padding:0 ">      // -------------------------</pre>
<pre style="margin:0; padding:0 ">      // Instantiate cfg registers</pre>
<pre style="margin:0; padding:0 ">      // -------------------------</pre>
<pre id="id771" style="background-color: #FFB6C1; margin:0; padding:0 ">      assign pmp_cfg_we[i] = csr_we_int & ~pmp_cfg[i].lock &</pre>
<pre id="id772" style="background-color: #FFB6C1; margin:0; padding:0 ">                             (csr_addr == (CSR_OFF_PMP_CFG + (i[11:0] >> 2)));</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // Select the correct WDATA (each CSR contains 4 CFG fields, each with 2 RES bits)</pre>
<pre id="id775" style="background-color: #FFB6C1; margin:0; padding:0 ">      assign pmp_cfg_wdata[i].lock  = csr_wdata_int[(i%4)*PMP_CFG_W+7];</pre>
<pre style="margin:0; padding:0 ">      // NA4 mode is not selectable when G > 0, mode is treated as OFF</pre>
<pre id="id777" style="background-color: #FFB6C1; margin:0; padding:0 ">      always_comb begin</pre>
<pre id="id778" style="background-color: #FFB6C1; margin:0; padding:0 ">        unique case (csr_wdata_int[(i%4)*PMP_CFG_W+3+:2])</pre>
<pre id="id779" style="background-color: #FFB6C1; margin:0; padding:0 ">          2'b00   : pmp_cfg_wdata[i].mode = PMP_MODE_OFF;</pre>
<pre id="id780" style="background-color: #FFB6C1; margin:0; padding:0 ">          2'b01   : pmp_cfg_wdata[i].mode = PMP_MODE_TOR;</pre>
<pre id="id781" style="background-color: #FFB6C1; margin:0; padding:0 ">          2'b10   : pmp_cfg_wdata[i].mode = (PMPGranularity == 0) ? PMP_MODE_NA4:</pre>
<pre id="id782" style="background-color: #FFB6C1; margin:0; padding:0 ">                                                                    PMP_MODE_OFF;</pre>
<pre id="id783" style="background-color: #FFB6C1; margin:0; padding:0 ">          2'b11   : pmp_cfg_wdata[i].mode = PMP_MODE_NAPOT;</pre>
<pre id="id784" style="background-color: #FFB6C1; margin:0; padding:0 ">          default : pmp_cfg_wdata[i].mode = PMP_MODE_OFF;</pre>
<pre style="margin:0; padding:0 ">        endcase</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre id="id787" style="background-color: #FFB6C1; margin:0; padding:0 ">      assign pmp_cfg_wdata[i].exec  = csr_wdata_int[(i%4)*PMP_CFG_W+2];</pre>
<pre style="margin:0; padding:0 ">      // W = 1, R = 0 is a reserved combination. For now, we force W to 0 if R == 0</pre>
<pre id="id789" style="background-color: #FFB6C1; margin:0; padding:0 ">      assign pmp_cfg_wdata[i].write = &csr_wdata_int[(i%4)*PMP_CFG_W+:2];</pre>
<pre id="id790" style="background-color: #FFB6C1; margin:0; padding:0 ">      assign pmp_cfg_wdata[i].read  = csr_wdata_int[(i%4)*PMP_CFG_W];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id792" style="background-color: #FFB6C1; margin:0; padding:0 ">      always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre id="id793" style="background-color: #FFB6C1; margin:0; padding:0 ">        if (!rst_ni) begin</pre>
<pre id="id794" style="background-color: #FFB6C1; margin:0; padding:0 ">          pmp_cfg[i] <= pmp_cfg_t'('b0);</pre>
<pre id="id795" style="background-color: #FFB6C1; margin:0; padding:0 ">        end else if (pmp_cfg_we[i]) begin</pre>
<pre id="id796" style="background-color: #FFB6C1; margin:0; padding:0 ">          pmp_cfg[i] <= pmp_cfg_wdata[i];</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // --------------------------</pre>
<pre style="margin:0; padding:0 ">      // Instantiate addr registers</pre>
<pre style="margin:0; padding:0 ">      // --------------------------</pre>
<pre id="id803" style="background-color: #FFB6C1; margin:0; padding:0 ">      if (i < PMPNumRegions - 1) begin : g_lower</pre>
<pre id="id804" style="background-color: #FFB6C1; margin:0; padding:0 ">        assign pmp_addr_we[i] = csr_we_int & ~pmp_cfg[i].lock &</pre>
<pre id="id805" style="background-color: #FFB6C1; margin:0; padding:0 ">                                (pmp_cfg[i+1].mode != PMP_MODE_TOR) &</pre>
<pre id="id806" style="background-color: #FFB6C1; margin:0; padding:0 ">                                (csr_addr == (CSR_OFF_PMP_ADDR + i[11:0]));</pre>
<pre id="id807" style="background-color: #FFB6C1; margin:0; padding:0 ">      end else begin : g_upper</pre>
<pre id="id808" style="background-color: #FFB6C1; margin:0; padding:0 ">        assign pmp_addr_we[i] = csr_we_int & ~pmp_cfg[i].lock &</pre>
<pre id="id809" style="background-color: #FFB6C1; margin:0; padding:0 ">                                (csr_addr == (CSR_OFF_PMP_ADDR + i[11:0]));</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id812" style="background-color: #FFB6C1; margin:0; padding:0 ">      always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre id="id813" style="background-color: #FFB6C1; margin:0; padding:0 ">        if (!rst_ni) begin</pre>
<pre id="id814" style="background-color: #FFB6C1; margin:0; padding:0 ">          pmp_addr[i] <= 'b0;</pre>
<pre id="id815" style="background-color: #FFB6C1; margin:0; padding:0 ">        end else if (pmp_addr_we[i]) begin</pre>
<pre id="id816" style="background-color: #FFB6C1; margin:0; padding:0 ">          pmp_addr[i] <= csr_wdata_int;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre id="id819" style="background-color: #FFB6C1; margin:0; padding:0 ">      assign csr_pmp_cfg_o[i]  = pmp_cfg[i];</pre>
<pre id="id820" style="background-color: #FFB6C1; margin:0; padding:0 ">      assign csr_pmp_addr_o[i] = {pmp_addr[i],2'b00};</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  end else begin : g_no_pmp_tieoffs</pre>
<pre style="margin:0; padding:0 ">    // Generate tieoffs when PMP is not configured</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    for (genvar i = 0; i < PMP_MAX_REGIONS; i++) begin : g_rdata</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      assign pmp_addr_rdata[i] = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      assign pmp_cfg_rdata[i]  = '0;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    for (genvar i = 0; i < PMPNumRegions; i++) begin : g_outputs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      assign csr_pmp_cfg_o[i]  = pmp_cfg_t'(1'b0);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      assign csr_pmp_addr_o[i] = '0;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  //////////////////////////</pre>
<pre style="margin:0; padding:0 ">  //  Performance monitor //</pre>
<pre style="margin:0; padding:0 ">  //////////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // update enable signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin : mcountinhibit_update</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (mcountinhibit_we == 1'b1) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mcountinhibit_d = {csr_wdata_int[MHPMCounterNum+2:2], 1'b0, csr_wdata_int[0]}; // bit 1 must always be 0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mcountinhibit_d = mcountinhibit_q;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // event selection (hardwired) & control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin : gen_mhpmcounter_incr</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // When adding or altering performance counter meanings and default</pre>
<pre style="margin:0; padding:0 ">    // mappings please update dv/verilator/pcount/cpp/ibex_pcounts.cc</pre>
<pre style="margin:0; padding:0 ">    // appropriately.</pre>
<pre style="margin:0; padding:0 ">    //</pre>
<pre style="margin:0; padding:0 ">    // active counters</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[0]  = 1'b1;                   // mcycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[1]  = 1'b0;                   // reserved</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[2]  = instr_ret_i;            // minstret</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[3]  = lsu_busy_i;             // cycles waiting for data memory</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[4]  = imiss_i & ~pc_set_i;    // cycles waiting for instr fetches</pre>
<pre style="margin:0; padding:0 ">                                                   // excl. jump and branch set cycles</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[5]  = mem_load_i;             // num of loads</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[6]  = mem_store_i;            // num of stores</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[7]  = jump_i;                 // num of jumps (unconditional)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[8]  = branch_i;               // num of branches (conditional)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[9]  = branch_taken_i;         // num of taken branches (conditional)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_incr[10] = instr_ret_compressed_i; // num of compressed instr</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // inactive counters</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    for (int unsigned i=3+MHPMCounterNum; i<32; i++) begin : gen_mhpmcounter_incr_inactive</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mhpmcounter_incr[i] = 1'b0;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // event selector (hardwired, 0 means no event)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin : gen_mhpmevent</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // activate all</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    for (int i=0; i<32; i++) begin : gen_mhpmevent_active</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mhpmevent[i]    =   '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mhpmevent[i][i] = 1'b1;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // deactivate</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmevent[1] = '0; // not existing, reserved</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    for (int unsigned i=3+MHPMCounterNum; i<32; i++) begin : gen_mhpmevent_inactive</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mhpmevent[i] = '0;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // update</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin : mhpmcounter_update</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    mhpmcounter_d = mhpmcounter;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    for (int i=0; i<32; i++) begin : gen_mhpmcounter_update</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // increment</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if (mhpmcounter_incr[i] & ~mcountinhibit[i]) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        mhpmcounter_d[i] = mhpmcounter[i] + 64'h1;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // write</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if (mhpmcounter_we[i]) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        mhpmcounter_d[i][31: 0] = csr_wdata_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      end else if (mhpmcounterh_we[i]) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        mhpmcounter_d[i][63:32] = csr_wdata_int;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Performance monitor registers</pre>
<pre style="margin:0; padding:0 ">  // Only elaborate flops that are needed from the given MHPMCounterWidth and MHPMCounterNum</pre>
<pre style="margin:0; padding:0 ">  // parameters</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  for (genvar i = 0; i < 32; i++) begin : g_mhpmcounter</pre>
<pre style="margin:0; padding:0 ">    // First 3 counters (cycle, time, instret) must always be elaborated</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (i < 3 + MHPMCounterNum) begin : g_mhpmcounter_exists</pre>
<pre style="margin:0; padding:0 ">      // First 3 counters must be 64-bit the rest have parameterisable width</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      localparam int unsigned IMHPMCounterWidth = i < 3 ? 64 : MHPMCounterWidth;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      logic [IMHPMCounterWidth-1:0] mhpmcounter_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      always @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if(~rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mhpmcounter_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          mhpmcounter_q <= mhpmcounter_d[i][IMHPMCounterWidth-1:0];</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if (IMHPMCounterWidth < 64) begin : g_mhpmcounter_narrow</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        assign mhpmcounter[i][IMHPMCounterWidth-1:0] = mhpmcounter_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        assign mhpmcounter[i][63:IMHPMCounterWidth]  = '0;</pre>
<pre id="id933" style="background-color: #FFB6C1; margin:0; padding:0 ">      end else begin : g_mhpmcounter_full</pre>
<pre id="id934" style="background-color: #FFB6C1; margin:0; padding:0 ">        assign mhpmcounter[i] = mhpmcounter_q;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin : g_no_mhpmcounter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      assign mhpmcounter[i] = '0;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  if(MHPMCounterNum < 29) begin : g_mcountinhibit_reduced</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign mcountinhibit = {{29-MHPMCounterNum{1'b1}}, mcountinhibit_q};</pre>
<pre id="id943" style="background-color: #FFB6C1; margin:0; padding:0 ">  end else begin : g_mcountinhibit_full</pre>
<pre id="id944" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign mcountinhibit = mcountinhibit_q;</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mcountinhibit_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      mcountinhibit_q <= mcountinhibit_d;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////////////////////</pre>
<pre style="margin:0; padding:0 ">  // Debug trigger registers //</pre>
<pre style="margin:0; padding:0 ">  /////////////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id959" style="background-color: #FFB6C1; margin:0; padding:0 ">  if (DbgTriggerEn) begin : gen_trigger_regs</pre>
<pre style="margin:0; padding:0 ">    // Register values</pre>
<pre id="id961" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic        tmatch_control_d, tmatch_control_q;</pre>
<pre id="id962" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic [31:0] tmatch_value_d, tmatch_value_q;</pre>
<pre style="margin:0; padding:0 ">    // Write enables</pre>
<pre id="id964" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic tmatch_control_we;</pre>
<pre id="id965" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic tmatch_value_we;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Write select</pre>
<pre id="id968" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign tmatch_control_we = csr_we_int & debug_mode_i & (csr_addr_i == CSR_TDATA1);</pre>
<pre id="id969" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign tmatch_value_we   = csr_we_int & debug_mode_i & (csr_addr_i == CSR_TDATA2);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // tmatch_control is enabled when the execute bit is set</pre>
<pre id="id972" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign tmatch_control_d = tmatch_control_we ? csr_wdata_int[2] :</pre>
<pre id="id973" style="background-color: #FFB6C1; margin:0; padding:0 ">                                                  tmatch_control_q;</pre>
<pre style="margin:0; padding:0 ">    // tmatch_value has its own clock gate</pre>
<pre id="id975" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign tmatch_value_d   = csr_wdata_int[31:0];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Registers</pre>
<pre id="id978" style="background-color: #FFB6C1; margin:0; padding:0 ">    always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre id="id979" style="background-color: #FFB6C1; margin:0; padding:0 ">      if (!rst_ni) begin</pre>
<pre id="id980" style="background-color: #FFB6C1; margin:0; padding:0 ">        tmatch_control_q <= 'b0;</pre>
<pre id="id981" style="background-color: #FFB6C1; margin:0; padding:0 ">      end else begin</pre>
<pre id="id982" style="background-color: #FFB6C1; margin:0; padding:0 ">        tmatch_control_q <= tmatch_control_d;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id986" style="background-color: #FFB6C1; margin:0; padding:0 ">    always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre id="id987" style="background-color: #FFB6C1; margin:0; padding:0 ">      if (!rst_ni) begin</pre>
<pre id="id988" style="background-color: #FFB6C1; margin:0; padding:0 ">        tmatch_value_q <= 'b0;</pre>
<pre id="id989" style="background-color: #FFB6C1; margin:0; padding:0 ">      end else if (tmatch_value_we) begin</pre>
<pre id="id990" style="background-color: #FFB6C1; margin:0; padding:0 ">        tmatch_value_q <= tmatch_value_d;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Assign read data</pre>
<pre style="margin:0; padding:0 ">    // TSELECT - only one supported</pre>
<pre id="id996" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign tselect_rdata = 'b0;</pre>
<pre style="margin:0; padding:0 ">    // TDATA0 - only support simple address matching</pre>
<pre id="id998" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign tmatch_control_rdata = {4'h2,              // type    : address/data match</pre>
<pre id="id999" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b1,              // dmode   : access from D mode only</pre>
<pre id="id1000" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   6'h00,             // maskmax : exact match only</pre>
<pre id="id1001" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b0,              // hit     : not supported</pre>
<pre id="id1002" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b0,              // select  : address match only</pre>
<pre id="id1003" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b0,              // timing  : match before execution</pre>
<pre id="id1004" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   2'b00,             // sizelo  : match any access</pre>
<pre id="id1005" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   4'h1,              // action  : enter debug mode</pre>
<pre id="id1006" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b0,              // chain   : not supported</pre>
<pre id="id1007" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   4'h0,              // match   : simple match</pre>
<pre id="id1008" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b1,              // m       : match in m-mode</pre>
<pre id="id1009" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b0,              // 0       : zero</pre>
<pre id="id1010" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b0,              // s       : not supported</pre>
<pre id="id1011" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b1,              // u       : match in u-mode</pre>
<pre id="id1012" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   tmatch_control_q,  // execute : match instruction address</pre>
<pre id="id1013" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b0,              // store   : not supported</pre>
<pre id="id1014" style="background-color: #FFB6C1; margin:0; padding:0 ">                                   1'b0};             // load    : not supported</pre>
<pre style="margin:0; padding:0 ">    // TDATA1 - address match value only</pre>
<pre id="id1016" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign tmatch_value_rdata = tmatch_value_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Breakpoint matching</pre>
<pre style="margin:0; padding:0 ">    // We match against the next address, as the breakpoint must be taken before execution</pre>
<pre id="id1020" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign trigger_match_o = tmatch_control_q & (pc_if_i[31:0] == tmatch_value_q[31:0]);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  end else begin : gen_no_trigger_regs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign tselect_rdata        = 'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign tmatch_control_rdata = 'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign tmatch_value_rdata   = 'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign trigger_match_o      = 'b0;</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ////////////////</pre>
<pre style="margin:0; padding:0 ">  // Assertions //</pre>
<pre style="margin:0; padding:0 ">  ////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Selectors must be known/valid.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexCsrOpValid, csr_op_i inside {</pre>
<pre style="margin:0; padding:0 ">      CSR_OP_READ,</pre>
<pre style="margin:0; padding:0 ">      CSR_OP_WRITE,</pre>
<pre style="margin:0; padding:0 ">      CSR_OP_SET,</pre>
<pre style="margin:0; padding:0 ">      CSR_OP_CLEAR</pre>
<pre style="margin:0; padding:0 ">      }, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IbexCsrWdataIntKnown, csr_wdata_int, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">endmodule</pre>
<pre style="margin:0; padding:0 "></pre>
</body>
</html>
