
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>../src/lowrisc_ip_usbdev_0.1/rtl/usbdev_iomux.sv Cov: 97% </h3>
<pre style="margin:0; padding:0 ">// Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">// Copyright ETH Zurich.</pre>
<pre style="margin:0; padding:0 ">// Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">// SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 ">//</pre>
<pre style="margin:0; padding:0 ">// USB IO Mux</pre>
<pre style="margin:0; padding:0 ">//</pre>
<pre style="margin:0; padding:0 ">// Muxes the USB IO signals from register access, differential signaling, single-ended signaling</pre>
<pre style="margin:0; padding:0 ">// and swaps D+/D- if configured. The incomming signals are also muxed and synchronized to the</pre>
<pre style="margin:0; padding:0 ">// corresponding clock domain.</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">module usbdev_iomux</pre>
<pre style="margin:0; padding:0 ">  import usbdev_reg_pkg::*;</pre>
<pre style="margin:0; padding:0 ">(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          clk_usb_48mhz_i, // use usb_ prefix for signals in this clk</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          rst_usb_48mhz_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Register interface (system clk, quasi-static)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  usbdev_reg2hw_phy_config_reg_t sys_reg2hw_config_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          sys_usb_sense_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // External USB Interface(s) (async)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          cio_usb_d_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          cio_usb_dp_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          cio_usb_dn_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          cio_usb_d_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          cio_usb_se0_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          cio_usb_dp_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          cio_usb_dn_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          cio_usb_oe_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          cio_usb_tx_mode_se_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          cio_usb_sense_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          cio_usb_dp_pullup_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          cio_usb_dn_pullup_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          cio_usb_suspend_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Internal USB Interface (usb clk)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          usb_rx_d_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          usb_rx_se0_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          usb_tx_d_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          usb_tx_se0_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          usb_tx_oe_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                          usb_pwr_sense_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          usb_pullup_en_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                          usb_suspend_i</pre>
<pre style="margin:0; padding:0 ">);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic async_pwr_sense, sys_usb_sense;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic cio_usb_dp, cio_usb_dn, cio_usb_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic usb_rx_dp, usb_rx_dn, usb_rx_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic pinflip;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic unused_eop_single_bit;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic unused_usb_ref_disable;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign unused_eop_single_bit  = sys_reg2hw_config_i.eop_single_bit.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign unused_usb_ref_disable = sys_reg2hw_config_i.usb_ref_disable.q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  //////////</pre>
<pre style="margin:0; padding:0 ">  // CDCs //</pre>
<pre style="margin:0; padding:0 ">  //////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // USB sense pin (to sysclk)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Width (1)</pre>
<pre id="id71" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) cdc_io_to_sys (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .d      ({cio_usb_sense_i}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .q      ({sys_usb_sense})</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign sys_usb_sense_o = sys_usb_sense;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // USB input pins (to usbclk)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Width (4)</pre>
<pre id="id83" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) cdc_io_to_usb (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .d      ({cio_usb_dp_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              cio_usb_dn_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              cio_usb_d_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              async_pwr_sense}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .q      ({cio_usb_dp,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              cio_usb_dn,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              cio_usb_d,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              usb_pwr_sense_o})</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ////////////////////////</pre>
<pre style="margin:0; padding:0 ">  // USB output pin mux //</pre>
<pre style="margin:0; padding:0 ">  ////////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // D+/D- can be swapped based on a config register.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign pinflip = sys_reg2hw_config_i.pinflip.q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign cio_usb_d_o            = pinflip ? ~usb_tx_d_i     : usb_tx_d_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign cio_usb_dp_pullup_en_o = pinflip ? 1'b0            : usb_pullup_en_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign cio_usb_dn_pullup_en_o = pinflip ? usb_pullup_en_i : 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin : proc_diff_se_mux_out</pre>
<pre style="margin:0; padding:0 ">    // Defaults</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    cio_usb_dn_o           = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    cio_usb_dp_o           = 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // The single-ended signals are only driven in single-ended mode.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (sys_reg2hw_config_i.tx_differential_mode.q) begin</pre>
<pre style="margin:0; padding:0 ">      // Differential TX mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      cio_usb_tx_mode_se_o   = 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="margin:0; padding:0 ">      // Single-ended TX mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      cio_usb_tx_mode_se_o   = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if (usb_tx_se0_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        cio_usb_dp_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        cio_usb_dn_o = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        cio_usb_dp_o = pinflip ? ~usb_tx_d_i :  usb_tx_d_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        cio_usb_dn_o = pinflip ?  usb_tx_d_i : ~usb_tx_d_i;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // It would be possible to insert explicit controllability muxes here.</pre>
<pre style="margin:0; padding:0 ">  // For now, we just pass the signal through</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign cio_usb_oe_o      = usb_tx_oe_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign cio_usb_se0_o     = usb_tx_se0_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign cio_usb_suspend_o = usb_suspend_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ///////////////////////</pre>
<pre style="margin:0; padding:0 ">  // USB input pin mux //</pre>
<pre style="margin:0; padding:0 ">  ///////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Note that while transmitting, we fix the receive line to 1. If the receive line isn't fixed,</pre>
<pre style="margin:0; padding:0 ">  // we are trying to regenerate the bit clock from the bit clock we are regenerating, rather than</pre>
<pre style="margin:0; padding:0 ">  // just holding the phase.</pre>
<pre style="margin:0; padding:0 ">  // D+/D- can be swapped based on a config register.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign usb_rx_dp = usb_tx_oe_i ? 1'b1 : (pinflip ?  cio_usb_dn : cio_usb_dp);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign usb_rx_dn = usb_tx_oe_i ? 1'b0 : (pinflip ?  cio_usb_dp : cio_usb_dn);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign usb_rx_d  = usb_tx_oe_i ? 1'b1 : (pinflip ? ~cio_usb_d  : cio_usb_d);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin : proc_diff_se_mux_in</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    usb_rx_se0_o = ~usb_rx_dp & ~usb_rx_dn;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (sys_reg2hw_config_i.rx_differential_mode.q) begin</pre>
<pre style="margin:0; padding:0 ">      // Differential RX mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      usb_rx_d_o = usb_rx_d;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="margin:0; padding:0 ">      // Single-ended RX mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      usb_rx_d_o = usb_rx_dp; // SE1 is interpreted as differential 1</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Power sense mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin : proc_mux_pwr_sense</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (sys_reg2hw_config_i.override_pwr_sense_en.q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      async_pwr_sense = sys_reg2hw_config_i.override_pwr_sense_val.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      async_pwr_sense = cio_usb_sense_i;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">endmodule</pre>
<pre style="margin:0; padding:0 "></pre>
</body>
</html>
