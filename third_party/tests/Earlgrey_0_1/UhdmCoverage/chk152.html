
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>../src/lowrisc_ibex_ibex_core_0.1/rtl/ibex_load_store_unit.sv Cov: 99% </h3>
<pre style="margin:0; padding:0 ">// Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">// Copyright 2018 ETH Zurich and University of Bologna, see also CREDITS.md.</pre>
<pre style="margin:0; padding:0 ">// Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">// SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">/**</pre>
<pre style="margin:0; padding:0 "> * Load Store Unit</pre>
<pre style="margin:0; padding:0 "> *</pre>
<pre style="margin:0; padding:0 "> * Load Store Unit, used to eliminate multiple access during processor stalls,</pre>
<pre style="margin:0; padding:0 "> * and to align bytes and halfwords.</pre>
<pre style="margin:0; padding:0 "> */</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">`include "prim_assert.sv"</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">module ibex_load_store_unit</pre>
<pre style="margin:0; padding:0 ">(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic         clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic         rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // data interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         data_req_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic         data_gnt_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic         data_rvalid_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic         data_err_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic         data_pmp_err_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]  data_addr_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         data_we_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [3:0]   data_be_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]  data_wdata_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]  data_rdata_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // signals to/from ID/EX stage</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic         lsu_we_i,             // write enable                     -> from ID/EX</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [1:0]   lsu_type_i,           // data type: word, half word, byte -> from ID/EX</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]  lsu_wdata_i,          // data to write to memory          -> from ID/EX</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic         lsu_sign_ext_i,       // sign extension                   -> from ID/EX</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]  lsu_rdata_o,          // requested data                   -> to ID/EX</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         lsu_rdata_valid_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic         lsu_req_i,            // data request                     -> from ID/EX</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]  adder_result_ex_i,    // address computed in ALU          -> from ID/EX</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         addr_incr_req_o,      // request address increment for</pre>
<pre style="margin:0; padding:0 ">                                               // misaligned accesses              -> to ID/EX</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]  addr_last_o,          // address of last transaction      -> to controller</pre>
<pre style="margin:0; padding:0 ">                                               // -> mtval</pre>
<pre style="margin:0; padding:0 ">                                               // -> AGU for misaligned accesses</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         lsu_req_done_o,       // Signals that data request is complete</pre>
<pre style="margin:0; padding:0 ">                                               // (only need to await final data</pre>
<pre style="margin:0; padding:0 ">                                               // response)                        -> to ID/EX</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         lsu_resp_valid_o,     // LSU has response from transaction -> to ID/EX</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // exception signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         load_err_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         store_err_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         busy_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         perf_load_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic         perf_store_o</pre>
<pre style="margin:0; padding:0 ">);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]  data_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]  data_addr_w_aligned;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]  addr_last_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic         addr_update;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic         ctrl_update;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic         rdata_update;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:8]  rdata_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [1:0]   rdata_offset_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [1:0]   data_type_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic         data_sign_ext_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic         data_we_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [1:0]   data_offset;   // mux control for data to be written to memory</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [3:0]   data_be;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]  data_wdata;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]  data_rdata_ext;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]  rdata_w_ext; // word realignment for misaligned loads</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]  rdata_h_ext; // sign extension for half words</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0]  rdata_b_ext; // sign extension for bytes</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic         split_misaligned_access;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic         handle_misaligned_q, handle_misaligned_d; // high after receiving grant for first</pre>
<pre id="id94" style="background-color: #FFB6C1; margin:0; padding:0 ">                                                          // part of a misaligned access</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic         pmp_err_q, pmp_err_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic         lsu_err_q, lsu_err_d;</pre>
<pre style="margin:0; padding:0 ">  logic         data_or_pmp_err;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  typedef enum logic [2:0]  {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    IDLE, WAIT_GNT_MIS, WAIT_RVALID_MIS, WAIT_GNT,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    WAIT_RVALID_MIS_GNTS_DONE</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  } ls_fsm_e;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  ls_fsm_e ls_fsm_cs, ls_fsm_ns;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign data_addr   = adder_result_ex_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign data_offset = data_addr[1:0];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ///////////////////</pre>
<pre style="margin:0; padding:0 ">  // BE generation //</pre>
<pre style="margin:0; padding:0 ">  ///////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (lsu_type_i) // Data type 00 Word, 01 Half word, 11,10 byte</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b00: begin // Writing a word</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!handle_misaligned_q) begin // first part of potentially misaligned transaction</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          unique case (data_offset)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b00:   data_be = 4'b1111;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b01:   data_be = 4'b1110;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b10:   data_be = 4'b1100;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b11:   data_be = 4'b1000;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            default: data_be = 4'b1111;</pre>
<pre style="margin:0; padding:0 ">          endcase // case (data_offset)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin // second part of misaligned transaction</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          unique case (data_offset)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b00:   data_be = 4'b0000; // this is not used, but included for completeness</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b01:   data_be = 4'b0001;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b10:   data_be = 4'b0011;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b11:   data_be = 4'b0111;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            default: data_be = 4'b1111;</pre>
<pre style="margin:0; padding:0 ">          endcase // case (data_offset)</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b01: begin // Writing a half word</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!handle_misaligned_q) begin // first part of potentially misaligned transaction</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          unique case (data_offset)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b00:   data_be = 4'b0011;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b01:   data_be = 4'b0110;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b10:   data_be = 4'b1100;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            2'b11:   data_be = 4'b1000;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            default: data_be = 4'b1111;</pre>
<pre style="margin:0; padding:0 ">          endcase // case (data_offset)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin // second part of misaligned transaction</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          data_be = 4'b0001;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b10,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b11: begin // Writing a byte</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        unique case (data_offset)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          2'b00:   data_be = 4'b0001;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          2'b01:   data_be = 4'b0010;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          2'b10:   data_be = 4'b0100;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          2'b11:   data_be = 4'b1000;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          default: data_be = 4'b1111;</pre>
<pre style="margin:0; padding:0 ">        endcase // case (data_offset)</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default:     data_be = 4'b1111;</pre>
<pre style="margin:0; padding:0 ">    endcase // case (lsu_type_i)</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////////////</pre>
<pre style="margin:0; padding:0 ">  // WData alignment //</pre>
<pre style="margin:0; padding:0 ">  /////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // prepare data to be written to the memory</pre>
<pre style="margin:0; padding:0 ">  // we handle misaligned accesses, half word and byte accesses here</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (data_offset)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b00:   data_wdata =  lsu_wdata_i[31:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b01:   data_wdata = {lsu_wdata_i[23:0], lsu_wdata_i[31:24]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b10:   data_wdata = {lsu_wdata_i[15:0], lsu_wdata_i[31:16]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b11:   data_wdata = {lsu_wdata_i[ 7:0], lsu_wdata_i[31: 8]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default: data_wdata =  lsu_wdata_i[31:0];</pre>
<pre style="margin:0; padding:0 ">    endcase // case (data_offset)</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////////////</pre>
<pre style="margin:0; padding:0 ">  // RData alignment //</pre>
<pre style="margin:0; padding:0 ">  /////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // register for unaligned rdata</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      rdata_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else if (rdata_update) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      rdata_q <= data_rdata_i[31:8];</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // registers for transaction control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      rdata_offset_q  <= 2'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      data_type_q     <= 2'h0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      data_sign_ext_q <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      data_we_q       <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else if (ctrl_update) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      rdata_offset_q  <= data_offset;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      data_type_q     <= lsu_type_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      data_sign_ext_q <= lsu_sign_ext_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      data_we_q       <= lsu_we_i;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Store last address for mtval + AGU for misaligned transactions.</pre>
<pre style="margin:0; padding:0 ">  // Do not update in case of errors, mtval needs the (first) failing address</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      addr_last_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else if (addr_update) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      addr_last_q <= data_addr;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // take care of misaligned words</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (rdata_offset_q)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b00:   rdata_w_ext =  data_rdata_i[31:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b01:   rdata_w_ext = {data_rdata_i[ 7:0], rdata_q[31:8]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b10:   rdata_w_ext = {data_rdata_i[15:0], rdata_q[31:16]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b11:   rdata_w_ext = {data_rdata_i[23:0], rdata_q[31:24]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default: rdata_w_ext =  data_rdata_i[31:0];</pre>
<pre style="margin:0; padding:0 ">    endcase</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ////////////////////</pre>
<pre style="margin:0; padding:0 ">  // Sign extension //</pre>
<pre style="margin:0; padding:0 ">  ////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // sign extension for half words</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (rdata_offset_q)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b00: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!data_sign_ext_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_h_ext = {16'h0000, data_rdata_i[15:0]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_h_ext = {{16{data_rdata_i[15]}}, data_rdata_i[15:0]};</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b01: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!data_sign_ext_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_h_ext = {16'h0000, data_rdata_i[23:8]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_h_ext = {{16{data_rdata_i[23]}}, data_rdata_i[23:8]};</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b10: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!data_sign_ext_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_h_ext = {16'h0000, data_rdata_i[31:16]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_h_ext = {{16{data_rdata_i[31]}}, data_rdata_i[31:16]};</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b11: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!data_sign_ext_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_h_ext = {16'h0000, data_rdata_i[7:0], rdata_q[31:24]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_h_ext = {{16{data_rdata_i[7]}}, data_rdata_i[7:0], rdata_q[31:24]};</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default: rdata_h_ext = {16'h0000, data_rdata_i[15:0]};</pre>
<pre style="margin:0; padding:0 ">    endcase // case (rdata_offset_q)</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // sign extension for bytes</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (rdata_offset_q)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b00: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!data_sign_ext_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_b_ext = {24'h00_0000, data_rdata_i[7:0]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_b_ext = {{24{data_rdata_i[7]}}, data_rdata_i[7:0]};</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b01: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!data_sign_ext_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_b_ext = {24'h00_0000, data_rdata_i[15:8]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_b_ext = {{24{data_rdata_i[15]}}, data_rdata_i[15:8]};</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b10: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!data_sign_ext_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_b_ext = {24'h00_0000, data_rdata_i[23:16]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_b_ext = {{24{data_rdata_i[23]}}, data_rdata_i[23:16]};</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b11: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (!data_sign_ext_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_b_ext = {24'h00_0000, data_rdata_i[31:24]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_b_ext = {{24{data_rdata_i[31]}}, data_rdata_i[31:24]};</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default: rdata_b_ext = {24'h00_0000, data_rdata_i[7:0]};</pre>
<pre style="margin:0; padding:0 ">    endcase // case (rdata_offset_q)</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // select word, half word or byte sign extended version</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (data_type_q)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b00:       data_rdata_ext = rdata_w_ext;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b01:       data_rdata_ext = rdata_h_ext;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      2'b10,2'b11: data_rdata_ext = rdata_b_ext;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default:     data_rdata_ext = rdata_w_ext;</pre>
<pre style="margin:0; padding:0 ">    endcase // case (data_type_q)</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="margin:0; padding:0 ">  // LSU FSM //</pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // check for misaligned accesses that need to be split into two word-aligned accesses</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign split_misaligned_access =</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      ((lsu_type_i == 2'b00) && (data_offset != 2'b00)) || // misaligned word access</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      ((lsu_type_i == 2'b01) && (data_offset == 2'b11));   // misaligned half-word access</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // FSM</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    ls_fsm_ns       = ls_fsm_cs;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    data_req_o          = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    addr_incr_req_o     = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    handle_misaligned_d = handle_misaligned_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    pmp_err_d           = pmp_err_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    lsu_err_d           = lsu_err_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    addr_update         = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    ctrl_update         = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    rdata_update        = 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    perf_load_o         = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    perf_store_o        = 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (ls_fsm_cs)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      IDLE: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        pmp_err_d = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (lsu_req_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          data_req_o   = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          pmp_err_d    = data_pmp_err_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          lsu_err_d    = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          perf_load_o  = ~lsu_we_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          perf_store_o = lsu_we_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          if (data_gnt_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            ctrl_update         = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            addr_update         = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            handle_misaligned_d = split_misaligned_access;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            ls_fsm_ns           = split_misaligned_access ? WAIT_RVALID_MIS : IDLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            ls_fsm_ns           = split_misaligned_access ? WAIT_GNT_MIS    : WAIT_GNT;</pre>
<pre style="margin:0; padding:0 ">          end</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      WAIT_GNT_MIS: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        data_req_o = 1'b1;</pre>
<pre style="margin:0; padding:0 ">        // data_pmp_err_i is valid during the address phase of a request. An error will block the</pre>
<pre style="margin:0; padding:0 ">        // external request and so a data_gnt_i might never be signalled. The registered version</pre>
<pre style="margin:0; padding:0 ">        // pmp_err_q is only updated for new address phases and so can be used in WAIT_GNT* and</pre>
<pre style="margin:0; padding:0 ">        // WAIT_RVALID* states</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (data_gnt_i || pmp_err_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          addr_update         = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          ctrl_update         = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          handle_misaligned_d = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          ls_fsm_ns           = WAIT_RVALID_MIS;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      WAIT_RVALID_MIS: begin</pre>
<pre style="margin:0; padding:0 ">        // push out second request</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        data_req_o = 1'b1;</pre>
<pre style="margin:0; padding:0 ">        // tell ID/EX stage to update the address</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        addr_incr_req_o = 1'b1;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        // first part rvalid is received, or gets a PMP error</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (data_rvalid_i || pmp_err_q) begin</pre>
<pre style="margin:0; padding:0 ">          // Update the PMP error for the second part</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          pmp_err_d = data_pmp_err_i;</pre>
<pre style="margin:0; padding:0 ">          // Record the error status of the first part</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          lsu_err_d = data_err_i | pmp_err_q;</pre>
<pre style="margin:0; padding:0 ">          // Capture the first rdata for loads</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_update = ~data_we_q;</pre>
<pre style="margin:0; padding:0 ">          // If already granted, wait for second rvalid</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          ls_fsm_ns = data_gnt_i ? IDLE : WAIT_GNT;</pre>
<pre style="margin:0; padding:0 ">          // Update the address for the second part, if no error</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          addr_update = data_gnt_i & ~(data_err_i | pmp_err_q);</pre>
<pre style="margin:0; padding:0 ">          // clear handle_misaligned if second request is granted</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          handle_misaligned_d = ~data_gnt_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end else begin</pre>
<pre style="margin:0; padding:0 ">          // first part rvalid is NOT received</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          if (data_gnt_i) begin</pre>
<pre style="margin:0; padding:0 ">            // second grant is received</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            ls_fsm_ns = WAIT_RVALID_MIS_GNTS_DONE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            handle_misaligned_d = 1'b0;</pre>
<pre style="margin:0; padding:0 ">          end</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      WAIT_GNT: begin</pre>
<pre style="margin:0; padding:0 ">        // tell ID/EX stage to update the address</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        addr_incr_req_o = handle_misaligned_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        data_req_o      = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (data_gnt_i || pmp_err_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          ctrl_update         = 1'b1;</pre>
<pre style="margin:0; padding:0 ">          // Update the address, unless there was an error</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          addr_update         = ~lsu_err_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          ls_fsm_ns           = IDLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          handle_misaligned_d = 1'b0;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      WAIT_RVALID_MIS_GNTS_DONE: begin</pre>
<pre style="margin:0; padding:0 ">        // tell ID/EX stage to update the address (to make sure the</pre>
<pre style="margin:0; padding:0 ">        // second address can be captured correctly for mtval and PMP checking)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        addr_incr_req_o = 1'b1;</pre>
<pre style="margin:0; padding:0 ">        // Wait for the first rvalid, second request is already granted</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        if (data_rvalid_i) begin</pre>
<pre style="margin:0; padding:0 ">          // Update the pmp error for the second part</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          pmp_err_d = data_pmp_err_i;</pre>
<pre style="margin:0; padding:0 ">          // The first part cannot see a PMP error in this state</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          lsu_err_d = data_err_i;</pre>
<pre style="margin:0; padding:0 ">          // Now we can update the address for the second part if no error</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          addr_update = ~data_err_i;</pre>
<pre style="margin:0; padding:0 ">          // Capture the first rdata for loads</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          rdata_update = ~data_we_q;</pre>
<pre style="margin:0; padding:0 ">          // Wait for second rvalid</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          ls_fsm_ns = IDLE;</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        ls_fsm_ns = IDLE;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    endcase</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign lsu_req_done_o = (lsu_req_i | (ls_fsm_cs != IDLE)) & (ls_fsm_ns == IDLE);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // registers for FSM</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      ls_fsm_cs           <= IDLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      handle_misaligned_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      pmp_err_q           <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      lsu_err_q           <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      ls_fsm_cs           <= ls_fsm_ns;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      handle_misaligned_q <= handle_misaligned_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      pmp_err_q           <= pmp_err_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      lsu_err_q           <= lsu_err_d;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="margin:0; padding:0 ">  // Outputs //</pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign data_or_pmp_err    = lsu_err_q | data_err_i | pmp_err_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign lsu_resp_valid_o   = (data_rvalid_i | pmp_err_q) & (ls_fsm_cs == IDLE);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign lsu_rdata_valid_o  = (ls_fsm_cs == IDLE) & data_rvalid_i & ~data_or_pmp_err & ~data_we_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // output to register file</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign lsu_rdata_o = data_rdata_ext;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // output data address must be word aligned</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign data_addr_w_aligned = {data_addr[31:2], 2'b00};</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // output to data interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign data_addr_o   = data_addr_w_aligned;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign data_wdata_o  = data_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign data_we_o     = lsu_we_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign data_be_o     = data_be;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // output to ID stage: mtval + AGU for misaligned transactions</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign addr_last_o   = addr_last_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Signal a load or store error depending on the transaction type outstanding</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign load_err_o    = data_or_pmp_err & ~data_we_q & lsu_resp_valid_o;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign store_err_o   = data_or_pmp_err &  data_we_q & lsu_resp_valid_o;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign busy_o = (ls_fsm_cs != IDLE);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ////////////////</pre>
<pre style="margin:0; padding:0 ">  // Assertions //</pre>
<pre style="margin:0; padding:0 ">  ////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Selectors must be known/valid.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexDataTypeKnown, (lsu_req_i | busy_o) |-> !$isunknown(lsu_type_i))</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexDataOffsetKnown, (lsu_req_i | busy_o) |-> !$isunknown(data_offset))</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IbexRDataOffsetQKnown, rdata_offset_q)</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IbexDataTypeQKnown, data_type_q)</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexLsuStateValid, ls_fsm_cs inside {</pre>
<pre style="margin:0; padding:0 ">      IDLE, WAIT_GNT_MIS, WAIT_RVALID_MIS, WAIT_GNT,</pre>
<pre style="margin:0; padding:0 ">      WAIT_RVALID_MIS_GNTS_DONE})</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Address must not contain X when request is sent.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexDataAddrUnknown, data_req_o |-> !$isunknown(data_addr_o))</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Address must be word aligned when request is sent.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexDataAddrUnaligned, data_req_o |-> (data_addr_o[1:0] == 2'b00))</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">endmodule</pre>
<pre style="margin:0; padding:0 "></pre>
</body>
</html>
