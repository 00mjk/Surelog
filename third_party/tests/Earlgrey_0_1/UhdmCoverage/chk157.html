
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>../src/lowrisc_ibex_ibex_core_0.1/rtl/ibex_wb_stage.sv Cov: 70% </h3>
<pre style="margin:0; padding:0 ">// Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">// Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">// SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">/**</pre>
<pre style="margin:0; padding:0 "> * Writeback Stage</pre>
<pre style="margin:0; padding:0 "> *</pre>
<pre style="margin:0; padding:0 "> * Writeback is an optional third pipeline stage. It writes data back to the register file that was</pre>
<pre style="margin:0; padding:0 "> * produced in the ID/EX stage or awaits a response to a load/store (LSU writes direct to register</pre>
<pre style="margin:0; padding:0 "> * file for load data). If the writeback stage is not present (WritebackStage == 0) this acts as</pre>
<pre style="margin:0; padding:0 "> * a simple passthrough to write data direct to the register file.</pre>
<pre style="margin:0; padding:0 "> */</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">`include "prim_assert.sv"</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">module ibex_wb_stage #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  parameter bit WritebackStage = 1'b0</pre>
<pre style="margin:0; padding:0 ">) (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                     clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                     rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                     en_wb_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  ibex_pkg::wb_instr_type_e instr_type_wb_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic [31:0]              pc_id_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                     ready_wb_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                     rf_write_wb_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                     outstanding_load_wb_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                     outstanding_store_wb_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic [31:0]              pc_wb_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic [4:0]               rf_waddr_id_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic [31:0]              rf_wdata_id_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                     rf_we_id_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic [31:0]              rf_wdata_lsu_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  logic                     rf_we_lsu_i,</pre>
<pre id="id38" style="background-color: #FFB6C1; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic [31:0]              rf_wdata_fwd_wb_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic [4:0]               rf_waddr_wb_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic [31:0]              rf_wdata_wb_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                     rf_we_wb_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input logic                      lsu_resp_valid_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic                     instr_done_wb_o</pre>
<pre style="margin:0; padding:0 ">);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  import ibex_pkg::*;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // 0 == RF write from ID</pre>
<pre style="margin:0; padding:0 ">  // 1 == RF write from LSU</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] rf_wdata_wb_mux    [2];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [1:0]  rf_wdata_wb_mux_we;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  if(WritebackStage) begin : g_writeback_stage</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic [31:0]    rf_wdata_wb_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic           rf_we_wb_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic [4:0]     rf_waddr_wb_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic           wb_done;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic           wb_valid_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic [31:0]    wb_pc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    wb_instr_type_e wb_instr_type_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic           wb_valid_d;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Stage becomes valid if an instruction enters for ID/EX and valid is cleared when instruction</pre>
<pre style="margin:0; padding:0 ">    // is done</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign wb_valid_d = (en_wb_i & ready_wb_o) | (wb_valid_q & ~wb_done);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Writeback for non load/store instructions always completes in a cycle (so instantly done)</pre>
<pre style="margin:0; padding:0 ">    // Writeback for load/store must wait for response to be received by the LSU</pre>
<pre style="margin:0; padding:0 ">    // Signal only relevant if wb_valid_q set</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign wb_done = (wb_instr_type_q == WB_INSTR_OTHER) | lsu_resp_valid_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if(~rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        wb_valid_q <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        wb_valid_q <= wb_valid_d;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    always_ff @(posedge clk_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if(en_wb_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        rf_we_wb_q      <= rf_we_id_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        rf_waddr_wb_q   <= rf_waddr_id_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        rf_wdata_wb_q   <= rf_wdata_id_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        wb_instr_type_q <= instr_type_wb_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        wb_pc_q         <= pc_id_i;</pre>
<pre id="id94" style="background-color: #FFB6C1; margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    assign rf_waddr_wb_o         = rf_waddr_wb_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_wdata_wb_mux[0]    = rf_wdata_wb_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_wdata_wb_mux_we[0] = rf_we_wb_q & wb_valid_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign ready_wb_o = ~wb_valid_q | wb_done;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Instruction in writeback will be writing to register file if either rf_we is set or writeback</pre>
<pre style="margin:0; padding:0 ">    // is awaiting load data. This is used for determining RF read hazards in ID/EX</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_write_wb_o = wb_valid_q & (rf_we_wb_q | (wb_instr_type_q == WB_INSTR_LOAD));</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign outstanding_load_wb_o  = wb_valid_q & (wb_instr_type_q == WB_INSTR_LOAD);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign outstanding_store_wb_o = wb_valid_q & (wb_instr_type_q == WB_INSTR_STORE);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign pc_wb_o = wb_pc_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign instr_done_wb_o = wb_valid_q & wb_done;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Forward data that will be written to the RF back to ID to resolve data hazards. The flopped</pre>
<pre style="margin:0; padding:0 ">    // rf_wdata_wb_q is used rather than rf_wdata_wb_o as the latter includes read data from memory</pre>
<pre style="margin:0; padding:0 ">    // that returns too late to be used on the forwarding path.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_wdata_fwd_wb_o = rf_wdata_wb_q;</pre>
<pre id="id118" style="background-color: #FFB6C1; margin:0; padding:0 ">  end else begin : g_bypass_wb</pre>
<pre style="margin:0; padding:0 ">    // without writeback stage just pass through register write signals</pre>
<pre id="id120" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign rf_waddr_wb_o         = rf_waddr_id_i;</pre>
<pre id="id121" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign rf_wdata_wb_mux[0]    = rf_wdata_id_i;</pre>
<pre id="id122" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign rf_wdata_wb_mux_we[0] = rf_we_id_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // ready needs to be constant 1 without writeback stage (otherwise ID/EX stage will stall)</pre>
<pre id="id125" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign ready_wb_o    = 1'b1;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Unused Writeback stage only IO & wiring</pre>
<pre style="margin:0; padding:0 ">    // Assign inputs and internal wiring to unused signals to satisfy lint checks</pre>
<pre style="margin:0; padding:0 ">    // Tie-off outputs to constant values</pre>
<pre id="id130" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic           unused_clk;</pre>
<pre id="id131" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic           unused_rst;</pre>
<pre id="id132" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic           unused_en_wb;</pre>
<pre id="id133" style="background-color: #FFB6C1; margin:0; padding:0 ">    wb_instr_type_e unused_instr_type_wb;</pre>
<pre id="id134" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic [31:0]    unused_pc_id;</pre>
<pre id="id135" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic           unused_lsu_resp_valid;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id137" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_clk            = clk_i;</pre>
<pre id="id138" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_rst            = rst_ni;</pre>
<pre id="id139" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_en_wb          = en_wb_i;</pre>
<pre id="id140" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_instr_type_wb  = instr_type_wb_i;</pre>
<pre id="id141" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_pc_id          = pc_id_i;</pre>
<pre id="id142" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_lsu_resp_valid = lsu_resp_valid_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id144" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign outstanding_load_wb_o  = 1'b0;</pre>
<pre id="id145" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign outstanding_store_wb_o = 1'b0;</pre>
<pre id="id146" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign pc_wb_o                = '0;</pre>
<pre id="id147" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign rf_write_wb_o          = 1'b0;</pre>
<pre id="id148" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign rf_wdata_fwd_wb_o      = 32'b0;</pre>
<pre id="id149" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign instr_done_wb_o        = 1'b0;</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rf_wdata_wb_mux[1]    = rf_wdata_lsu_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rf_wdata_wb_mux_we[1] = rf_we_lsu_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // RF write data can come from ID results (all RF writes that aren't because of loads will come</pre>
<pre style="margin:0; padding:0 ">  // from here) or the LSU (RF writes for load data)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rf_wdata_wb_o = rf_wdata_wb_mux_we[0] ? rf_wdata_wb_mux[0] : rf_wdata_wb_mux[1];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rf_we_wb_o    = |rf_wdata_wb_mux_we;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  `ASSERT(RFWriteFromOneSourceOnly, $onehot0(rf_wdata_wb_mux_we))</pre>
<pre style="margin:0; padding:0 ">endmodule</pre>
<pre style="margin:0; padding:0 "></pre>
</body>
</html>
