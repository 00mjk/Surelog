
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>../src/lowrisc_ibex_ibex_core_0.1/rtl/ibex_id_stage.sv Cov: 87% </h3>
<pre style="margin:0; padding:0 ">// Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">// Copyright 2018 ETH Zurich and University of Bologna, see also CREDITS.md.</pre>
<pre style="margin:0; padding:0 ">// Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">// SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">`ifdef RISCV_FORMAL</pre>
<pre style="margin:0; padding:0 ">  `define RVFI</pre>
<pre style="margin:0; padding:0 ">`endif</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">/**</pre>
<pre style="margin:0; padding:0 "> * Instruction Decode Stage</pre>
<pre style="margin:0; padding:0 "> *</pre>
<pre style="margin:0; padding:0 "> * Decode stage of the core. It decodes the instructions and hosts the register</pre>
<pre style="margin:0; padding:0 "> * file.</pre>
<pre style="margin:0; padding:0 "> */</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">`include "prim_assert.sv"</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">module ibex_id_stage #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit RV32E           = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit RV32M           = 1,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit RV32B           = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit DataIndTiming   = 1'b0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit BranchTargetALU = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit SpecBranch      = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    parameter bit WritebackStage  = 0</pre>
<pre style="margin:0; padding:0 ">) (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      fetch_enable_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      ctrl_busy_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      illegal_insn_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Interface to IF stage</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      instr_valid_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]               instr_rdata_i,         // from IF-ID pipeline registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]               instr_rdata_alu_i,     // from IF-ID pipeline registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [15:0]               instr_rdata_c_i,       // from IF-ID pipeline registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      instr_is_compressed_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      instr_req_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      instr_first_cycle_id_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      instr_valid_clear_o,   // kill instr in IF-ID reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      id_in_ready_o,         // ID stage is ready for next instr</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      icache_inval_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Jumps and branches</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      branch_decision_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // IF and ID stage signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      pc_set_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      pc_set_spec_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::pc_sel_e         pc_mux_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::exc_pc_sel_e     exc_pc_mux_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::exc_cause_e      exc_cause_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      illegal_c_insn_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      instr_fetch_err_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      instr_fetch_err_plus2_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]               pc_id_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Stalls</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      ex_valid_i,       // EX stage has valid output</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      lsu_resp_valid_i, // LSU has valid output, or is done</pre>
<pre style="margin:0; padding:0 ">    // ALU</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::alu_op_e         alu_operator_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]               alu_operand_a_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]               alu_operand_b_ex_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Multicycle Operation Stage Register</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      imd_val_we_ex_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [33:0]               imd_val_d_ex_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [33:0]               imd_val_q_ex_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Branch target ALU</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]               bt_a_operand_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]               bt_b_operand_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // MUL, DIV</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      mult_en_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      div_en_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      mult_sel_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      div_sel_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::md_op_e          multdiv_operator_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic  [1:0]               multdiv_signed_mode_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]               multdiv_operand_a_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]               multdiv_operand_b_ex_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      multdiv_ready_id_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // CSR</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      csr_access_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::csr_op_e         csr_op_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      csr_op_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      csr_save_if_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      csr_save_id_o,</pre>
<pre style="margin:0; padding:0 ">    output logic                      csr_save_wb_o,</pre>
<pre style="margin:0; padding:0 ">    output logic                      csr_restore_mret_id_o,</pre>
<pre style="margin:0; padding:0 ">    output logic                      csr_restore_dret_id_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      csr_save_cause_o,</pre>
<pre style="margin:0; padding:0 ">    output logic [31:0]               csr_mtval_o,</pre>
<pre style="margin:0; padding:0 ">    input  ibex_pkg::priv_lvl_e       priv_mode_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      csr_mstatus_tw_i,</pre>
<pre style="margin:0; padding:0 ">    input  logic                      illegal_csr_insn_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      data_ind_timing_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Interface to load store unit</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      lsu_req_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      lsu_we_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [1:0]                lsu_type_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      lsu_sign_ext_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]               lsu_wdata_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      lsu_req_done_i, // Data req to LSU is complete and</pre>
<pre style="margin:0; padding:0 ">                                                      // instruction can move to writeback</pre>
<pre style="margin:0; padding:0 ">                                                      // (only relevant where writeback stage is</pre>
<pre style="margin:0; padding:0 ">                                                      // present)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      lsu_addr_incr_req_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]               lsu_addr_last_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Interrupt signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      csr_mstatus_mie_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      irq_pending_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  ibex_pkg::irqs_t           irqs_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      irq_nm_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      nmi_mode_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      lsu_load_err_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      lsu_store_err_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Debug Signal</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      debug_mode_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output ibex_pkg::dbg_cause_e      debug_cause_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      debug_csr_save_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      debug_req_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      debug_single_step_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      debug_ebreakm_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      debug_ebreaku_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      trigger_match_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Write back signal</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]               result_ex_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]               csr_rdata_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Register file read</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [4:0]                rf_raddr_a_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]               rf_rdata_a_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [4:0]                rf_raddr_b_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]               rf_rdata_b_i,</pre>
<pre style="margin:0; padding:0 ">`ifdef RVFI</pre>
<pre style="margin:0; padding:0 ">    output logic                      rf_ren_a_o,</pre>
<pre style="margin:0; padding:0 ">    output logic                      rf_ren_b_o,</pre>
<pre style="margin:0; padding:0 ">`endif</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Register file write (via writeback)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [4:0]                rf_waddr_id_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic [31:0]               rf_wdata_id_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      rf_we_id_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Register write information from writeback (for resolving data hazards)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [4:0]                rf_waddr_wb_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic [31:0]               rf_wdata_fwd_wb_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input  logic                      rf_write_wb_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output  logic                     en_wb_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output  ibex_pkg::wb_instr_type_e instr_type_wb_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input logic                       ready_wb_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input logic                       outstanding_load_wb_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    input logic                       outstanding_store_wb_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Performance Counters</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      perf_jump_o,    // executing a jump instr</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      perf_branch_o,  // executing a branch instr</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      perf_tbranch_o, // executing a taken branch instr</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      perf_dside_wait_o, // instruction in ID/EX is awaiting memory</pre>
<pre style="margin:0; padding:0 ">                                                         // access to finish before proceeding</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      perf_mul_wait_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      perf_div_wait_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      instr_id_done_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    output logic                      instr_id_done_compressed_o</pre>
<pre style="margin:0; padding:0 ">);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  import ibex_pkg::*;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Decoder/Controller, ID stage internal signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        illegal_insn_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        ebrk_insn;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        mret_insn_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        dret_insn_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        ecall_insn_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        wfi_insn_dec;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        wb_exception;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        branch_in_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        branch_spec, branch_set_spec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        branch_set, branch_set_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        branch_taken;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        jump_in_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        jump_set_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        jump_set;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        instr_first_cycle;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        instr_executing;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        instr_done;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        controller_run;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        stall_ld_hz;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        stall_mem;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        lsu_req_in_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        stall_multdiv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        stall_branch;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        stall_jump;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        stall_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        stall_wb;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        flush_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        multicycle_done;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Immediate decoding and sign extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] imm_i_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] imm_s_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] imm_b_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] imm_u_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] imm_j_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] zimm_rs1_type;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] imm_a;       // contains the immediate for operand b</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] imm_b;       // contains the immediate for operand b</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Register file interface</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  rf_wd_sel_e  rf_wdata_sel;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        rf_we_dec, rf_we_raw;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        rf_ren_a, rf_ren_b;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">`ifdef RVFI</pre>
<pre style="margin:0; padding:0 ">  assign rf_ren_a_o = rf_ren_a;</pre>
<pre style="margin:0; padding:0 ">  assign rf_ren_b_o = rf_ren_b;</pre>
<pre style="margin:0; padding:0 ">`endif</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] rf_rdata_a_fwd;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] rf_rdata_b_fwd;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // ALU Control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  alu_op_e     alu_operator;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  op_a_sel_e   alu_op_a_mux_sel, alu_op_a_mux_sel_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  op_b_sel_e   alu_op_b_mux_sel, alu_op_b_mux_sel_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        alu_multicycle_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        stall_alu;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [33:0] imd_val_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  op_a_sel_e   bt_a_mux_sel;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  imm_b_sel_e  bt_b_mux_sel;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  imm_a_sel_e  imm_a_mux_sel;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  imm_b_sel_e  imm_b_mux_sel, imm_b_mux_sel_dec;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Multiplier Control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        mult_en_id, mult_en_dec; // use integer multiplier</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        div_en_id, div_en_dec;   // use integer division or reminder</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        multdiv_en_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  md_op_e      multdiv_operator;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [1:0]  multdiv_signed_mode;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Data Memory Control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        lsu_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [1:0]  lsu_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        lsu_sign_ext;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        lsu_req, lsu_req_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        data_req_allowed;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // CSR control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        csr_pipe_flush;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] alu_operand_a;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [31:0] alu_operand_b;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="margin:0; padding:0 ">  // LSU Mux //</pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Misaligned loads/stores result in two aligned loads/stores, compute second address</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign alu_op_a_mux_sel = lsu_addr_incr_req_i ? OP_A_FWD        : alu_op_a_mux_sel_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign alu_op_b_mux_sel = lsu_addr_incr_req_i ? OP_B_IMM        : alu_op_b_mux_sel_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign imm_b_mux_sel    = lsu_addr_incr_req_i ? IMM_B_INCR_ADDR : imm_b_mux_sel_dec;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ///////////////////</pre>
<pre style="margin:0; padding:0 ">  // Operand MUXES //</pre>
<pre style="margin:0; padding:0 ">  ///////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Main ALU immediate MUX for Operand A</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign imm_a = (imm_a_mux_sel == IMM_A_Z) ? zimm_rs1_type : '0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Main ALU MUX for Operand A</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_comb begin : alu_operand_a_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    unique case (alu_op_a_mux_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      OP_A_REG_A:  alu_operand_a = rf_rdata_a_fwd;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      OP_A_FWD:    alu_operand_a = lsu_addr_last_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      OP_A_CURRPC: alu_operand_a = pc_id_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      OP_A_IMM:    alu_operand_a = imm_a;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      default:     alu_operand_a = pc_id_i;</pre>
<pre style="margin:0; padding:0 ">    endcase</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  if (BranchTargetALU) begin : g_btalu_muxes</pre>
<pre style="margin:0; padding:0 ">    // Branch target ALU operand A mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    always_comb begin : bt_operand_a_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      unique case (bt_a_mux_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        OP_A_REG_A:  bt_a_operand_o = rf_rdata_a_fwd;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        OP_A_CURRPC: bt_a_operand_o = pc_id_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        default:     bt_a_operand_o = pc_id_i;</pre>
<pre style="margin:0; padding:0 ">      endcase</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Branch target ALU operand B mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    always_comb begin : bt_immediate_b_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      unique case (bt_b_mux_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_I:         bt_b_operand_o = imm_i_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_B:         bt_b_operand_o = imm_b_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_J:         bt_b_operand_o = imm_j_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_INCR_PC:   bt_b_operand_o = instr_is_compressed_i ? 32'h2 : 32'h4;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        default:         bt_b_operand_o = instr_is_compressed_i ? 32'h2 : 32'h4;</pre>
<pre style="margin:0; padding:0 ">      endcase</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Reduced main ALU immediate MUX for Operand B</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    always_comb begin : immediate_b_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      unique case (imm_b_mux_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_I:         imm_b = imm_i_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_S:         imm_b = imm_s_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_U:         imm_b = imm_u_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_INCR_PC:   imm_b = instr_is_compressed_i ? 32'h2 : 32'h4;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_INCR_ADDR: imm_b = 32'h4;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        default:         imm_b = 32'h4;</pre>
<pre style="margin:0; padding:0 ">      endcase</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">    `ASSERT(IbexImmBMuxSelValid, instr_valid_i |-> imm_b_mux_sel inside {</pre>
<pre style="margin:0; padding:0 ">        IMM_B_I,</pre>
<pre id="id340" style="background-color: #FFB6C1; margin:0; padding:0 ">        IMM_B_S,</pre>
<pre id="id341" style="background-color: #FFB6C1; margin:0; padding:0 ">        IMM_B_U,</pre>
<pre id="id342" style="background-color: #FFB6C1; margin:0; padding:0 ">        IMM_B_INCR_PC,</pre>
<pre style="margin:0; padding:0 ">        IMM_B_INCR_ADDR})</pre>
<pre id="id344" style="background-color: #FFB6C1; margin:0; padding:0 ">  end else begin : g_nobtalu</pre>
<pre id="id345" style="background-color: #FFB6C1; margin:0; padding:0 ">    op_a_sel_e  unused_a_mux_sel;</pre>
<pre id="id346" style="background-color: #FFB6C1; margin:0; padding:0 ">    imm_b_sel_e unused_b_mux_sel;</pre>
<pre id="id347" style="background-color: #FFB6C1; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    assign unused_a_mux_sel = bt_a_mux_sel;</pre>
<pre style="margin:0; padding:0 ">    assign unused_b_mux_sel = bt_b_mux_sel;</pre>
<pre id="id350" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign bt_a_operand_o   = '0;</pre>
<pre id="id351" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign bt_b_operand_o   = '0;</pre>
<pre id="id352" style="background-color: #FFB6C1; margin:0; padding:0 "></pre>
<pre id="id353" style="background-color: #FFB6C1; margin:0; padding:0 ">    // Full main ALU immediate MUX for Operand B</pre>
<pre id="id354" style="background-color: #FFB6C1; margin:0; padding:0 ">    always_comb begin : immediate_b_mux</pre>
<pre id="id355" style="background-color: #FFB6C1; margin:0; padding:0 ">      unique case (imm_b_mux_sel)</pre>
<pre id="id356" style="background-color: #FFB6C1; margin:0; padding:0 ">        IMM_B_I:         imm_b = imm_i_type;</pre>
<pre id="id357" style="background-color: #FFB6C1; margin:0; padding:0 ">        IMM_B_S:         imm_b = imm_s_type;</pre>
<pre id="id358" style="background-color: #FFB6C1; margin:0; padding:0 ">        IMM_B_B:         imm_b = imm_b_type;</pre>
<pre id="id359" style="background-color: #FFB6C1; margin:0; padding:0 ">        IMM_B_U:         imm_b = imm_u_type;</pre>
<pre style="margin:0; padding:0 ">        IMM_B_J:         imm_b = imm_j_type;</pre>
<pre style="margin:0; padding:0 ">        IMM_B_INCR_PC:   imm_b = instr_is_compressed_i ? 32'h2 : 32'h4;</pre>
<pre style="margin:0; padding:0 ">        IMM_B_INCR_ADDR: imm_b = 32'h4;</pre>
<pre style="margin:0; padding:0 ">        default:         imm_b = 32'h4;</pre>
<pre style="margin:0; padding:0 ">      endcase</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">    `ASSERT(IbexImmBMuxSelValid, instr_valid_i |-> imm_b_mux_sel inside {</pre>
<pre style="margin:0; padding:0 ">        IMM_B_I,</pre>
<pre style="margin:0; padding:0 ">        IMM_B_S,</pre>
<pre style="margin:0; padding:0 ">        IMM_B_B,</pre>
<pre style="margin:0; padding:0 ">        IMM_B_U,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        IMM_B_J,</pre>
<pre style="margin:0; padding:0 ">        IMM_B_INCR_PC,</pre>
<pre style="margin:0; padding:0 ">        IMM_B_INCR_ADDR})</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // ALU MUX for Operand B</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign alu_operand_b = (alu_op_b_mux_sel == OP_B_IMM) ? imm_b : rf_rdata_b_fwd;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  /////////////////////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  // Multicycle Operation Stage Register //</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  /////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin : intermediate_val_reg</pre>
<pre style="margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      imd_val_q <= '0;</pre>
<pre style="margin:0; padding:0 ">    end else if (imd_val_we_ex_i) begin</pre>
<pre style="margin:0; padding:0 ">      imd_val_q <= imd_val_d_ex_i;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  assign imd_val_q_ex_o = imd_val_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ///////////////////////</pre>
<pre style="margin:0; padding:0 ">  // Register File MUX //</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  ///////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  // Suppress register write if there is an illegal CSR access or instruction is not executing</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rf_we_id_o = rf_we_raw & instr_executing & ~illegal_csr_insn_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre id="id400" style="background-color: #FFB6C1; margin:0; padding:0 ">  // Register file write data mux</pre>
<pre style="margin:0; padding:0 ">  always_comb begin : rf_wdata_id_mux</pre>
<pre style="margin:0; padding:0 ">    unique case (rf_wdata_sel)</pre>
<pre style="margin:0; padding:0 ">      RF_WD_EX:  rf_wdata_id_o = result_ex_i;</pre>
<pre style="margin:0; padding:0 ">      RF_WD_CSR: rf_wdata_id_o = csr_rdata_i;</pre>
<pre style="margin:0; padding:0 ">      default:   rf_wdata_id_o = result_ex_i;</pre>
<pre style="margin:0; padding:0 ">    endcase;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  /////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  // Decoder //</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  /////////////</pre>
<pre id="id412" style="background-color: #FFB6C1; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  ibex_decoder #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .RV32E           ( RV32E           ),</pre>
<pre style="margin:0; padding:0 ">      .RV32M           ( RV32M           ),</pre>
<pre style="margin:0; padding:0 ">      .RV32B           ( RV32B           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .BranchTargetALU ( BranchTargetALU )</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  ) decoder_i (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .clk_i                           ( clk_i                ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .rst_ni                          ( rst_ni               ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // controller</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .illegal_insn_o                  ( illegal_insn_dec     ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .ebrk_insn_o                     ( ebrk_insn            ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .mret_insn_o                     ( mret_insn_dec        ),</pre>
<pre style="margin:0; padding:0 ">      .dret_insn_o                     ( dret_insn_dec        ),</pre>
<pre style="margin:0; padding:0 ">      .ecall_insn_o                    ( ecall_insn_dec       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .wfi_insn_o                      ( wfi_insn_dec         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .jump_set_o                      ( jump_set_dec         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .branch_taken_i                  ( branch_taken         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .icache_inval_o                  ( icache_inval_o       ),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // from IF-ID pipeline register</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .instr_first_cycle_i             ( instr_first_cycle    ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .instr_rdata_i                   ( instr_rdata_i        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .instr_rdata_alu_i               ( instr_rdata_alu_i    ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .illegal_c_insn_i                ( illegal_c_insn_i     ),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // immediates</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .imm_a_mux_sel_o                 ( imm_a_mux_sel        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .imm_b_mux_sel_o                 ( imm_b_mux_sel_dec    ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .bt_a_mux_sel_o                  ( bt_a_mux_sel         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .bt_b_mux_sel_o                  ( bt_b_mux_sel         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      .imm_i_type_o                    ( imm_i_type           ),</pre>
<pre style="margin:0; padding:0 ">      .imm_s_type_o                    ( imm_s_type           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .imm_b_type_o                    ( imm_b_type           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .imm_u_type_o                    ( imm_u_type           ),</pre>
<pre style="margin:0; padding:0 ">      .imm_j_type_o                    ( imm_j_type           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .zimm_rs1_type_o                 ( zimm_rs1_type        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // register file</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .rf_wdata_sel_o                  ( rf_wdata_sel         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .rf_we_o                         ( rf_we_dec            ),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      .rf_raddr_a_o                    ( rf_raddr_a_o         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .rf_raddr_b_o                    ( rf_raddr_b_o         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .rf_waddr_o                      ( rf_waddr_id_o        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .rf_ren_a_o                      ( rf_ren_a             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .rf_ren_b_o                      ( rf_ren_b             ),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // ALU</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .alu_operator_o                  ( alu_operator         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .alu_op_a_mux_sel_o              ( alu_op_a_mux_sel_dec ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .alu_op_b_mux_sel_o              ( alu_op_b_mux_sel_dec ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .alu_multicycle_o                ( alu_multicycle_dec   ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // MULT & DIV</pre>
<pre style="margin:0; padding:0 ">      .mult_en_o                       ( mult_en_dec          ),</pre>
<pre style="margin:0; padding:0 ">      .div_en_o                        ( div_en_dec           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .mult_sel_o                      ( mult_sel_ex_o        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .div_sel_o                       ( div_sel_ex_o         ),</pre>
<pre style="margin:0; padding:0 ">      .multdiv_operator_o              ( multdiv_operator     ),</pre>
<pre style="margin:0; padding:0 ">      .multdiv_signed_mode_o           ( multdiv_signed_mode  ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // CSRs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .csr_access_o                    ( csr_access_o         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .csr_op_o                        ( csr_op_o             ),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // LSU</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .data_req_o                      ( lsu_req_dec          ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .data_we_o                       ( lsu_we               ),</pre>
<pre style="margin:0; padding:0 ">      .data_type_o                     ( lsu_type             ),</pre>
<pre style="margin:0; padding:0 ">      .data_sign_extension_o           ( lsu_sign_ext         ),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // jump/branches</pre>
<pre style="margin:0; padding:0 ">      .jump_in_dec_o                   ( jump_in_dec          ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .branch_in_dec_o                 ( branch_in_dec        )</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////////////////////////</pre>
<pre style="margin:0; padding:0 ">  // CSR-related pipline flushes //</pre>
<pre style="margin:0; padding:0 ">  /////////////////////////////////</pre>
<pre style="margin:0; padding:0 ">  always_comb begin : csr_pipeline_flushes</pre>
<pre style="margin:0; padding:0 ">    csr_pipe_flush = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    // A pipeline flush is needed to let the controller react after modifying certain CSRs:</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    // - When enabling interrupts, pending IRQs become visible to the controller only during</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    //   the next cycle. If during that cycle the core disables interrupts again, it does not</pre>
<pre style="margin:0; padding:0 ">    //   see any pending IRQs and consequently does not start to handle interrupts.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    // - When modifying debug CSRs - TODO: Check if this is really needed</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (csr_op_en_o == 1'b1 && (csr_op_o == CSR_OP_WRITE || csr_op_o == CSR_OP_SET)) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      if (csr_num_e'(instr_rdata_i[31:20]) == CSR_MSTATUS   ||</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          csr_num_e'(instr_rdata_i[31:20]) == CSR_MIE) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        csr_pipe_flush = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end else if (csr_op_en_o == 1'b1 && csr_op_o != CSR_OP_READ) begin</pre>
<pre style="margin:0; padding:0 ">      if (csr_num_e'(instr_rdata_i[31:20]) == CSR_DCSR      ||</pre>
<pre style="margin:0; padding:0 ">          csr_num_e'(instr_rdata_i[31:20]) == CSR_DPC       ||</pre>
<pre style="margin:0; padding:0 ">          csr_num_e'(instr_rdata_i[31:20]) == CSR_DSCRATCH0 ||</pre>
<pre style="margin:0; padding:0 ">          csr_num_e'(instr_rdata_i[31:20]) == CSR_DSCRATCH1) begin</pre>
<pre style="margin:0; padding:0 ">        csr_pipe_flush = 1'b1;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  ////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  // Controller //</pre>
<pre id="id519" style="background-color: #FFB6C1; margin:0; padding:0 ">  ////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign illegal_insn_o = instr_valid_i & (illegal_insn_dec | illegal_csr_insn_i);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  ibex_controller #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .WritebackStage ( WritebackStage )</pre>
<pre style="margin:0; padding:0 ">  ) controller_i (</pre>
<pre style="margin:0; padding:0 ">      .clk_i                          ( clk_i                   ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .rst_ni                         ( rst_ni                  ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .fetch_enable_i                 ( fetch_enable_i          ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .ctrl_busy_o                    ( ctrl_busy_o             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // decoder related signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .illegal_insn_i                 ( illegal_insn_o          ),</pre>
<pre style="margin:0; padding:0 ">      .ecall_insn_i                   ( ecall_insn_dec          ),</pre>
<pre style="margin:0; padding:0 ">      .mret_insn_i                    ( mret_insn_dec           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .dret_insn_i                    ( dret_insn_dec           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .wfi_insn_i                     ( wfi_insn_dec            ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .ebrk_insn_i                    ( ebrk_insn               ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .csr_pipe_flush_i               ( csr_pipe_flush          ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // from IF-ID pipeline</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .instr_valid_i                  ( instr_valid_i           ),</pre>
<pre style="margin:0; padding:0 ">      .instr_i                        ( instr_rdata_i           ),</pre>
<pre style="margin:0; padding:0 ">      .instr_compressed_i             ( instr_rdata_c_i         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .instr_is_compressed_i          ( instr_is_compressed_i   ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .instr_fetch_err_i              ( instr_fetch_err_i       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .instr_fetch_err_plus2_i        ( instr_fetch_err_plus2_i ),</pre>
<pre style="margin:0; padding:0 ">      .pc_id_i                        ( pc_id_i                 ),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // to IF-ID pipeline</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .instr_valid_clear_o            ( instr_valid_clear_o     ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .id_in_ready_o                  ( id_in_ready_o           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .controller_run_o               ( controller_run          ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // to prefetcher</pre>
<pre style="margin:0; padding:0 ">      .instr_req_o                    ( instr_req_o             ),</pre>
<pre style="margin:0; padding:0 ">      .pc_set_o                       ( pc_set_o                ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .pc_set_spec_o                  ( pc_set_spec_o           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .pc_mux_o                       ( pc_mux_o                ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .exc_pc_mux_o                   ( exc_pc_mux_o            ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .exc_cause_o                    ( exc_cause_o             ),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // LSU</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .lsu_addr_last_i                ( lsu_addr_last_i         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .load_err_i                     ( lsu_load_err_i          ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .store_err_i                    ( lsu_store_err_i         ),</pre>
<pre style="margin:0; padding:0 ">      .wb_exception_o                 ( wb_exception            ),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // jump/branch control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .branch_set_i                   ( branch_set              ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .branch_set_spec_i              ( branch_set_spec         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .jump_set_i                     ( jump_set                ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // interrupt signals</pre>
<pre style="margin:0; padding:0 ">      .csr_mstatus_mie_i              ( csr_mstatus_mie_i       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .irq_pending_i                  ( irq_pending_i           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .irqs_i                         ( irqs_i                  ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .irq_nm_i                       ( irq_nm_i                ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .nmi_mode_o                     ( nmi_mode_o              ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // CSR Controller Signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .csr_save_if_o                  ( csr_save_if_o           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .csr_save_id_o                  ( csr_save_id_o           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .csr_save_wb_o                  ( csr_save_wb_o           ),</pre>
<pre style="margin:0; padding:0 ">      .csr_restore_mret_id_o          ( csr_restore_mret_id_o   ),</pre>
<pre style="margin:0; padding:0 ">      .csr_restore_dret_id_o          ( csr_restore_dret_id_o   ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .csr_save_cause_o               ( csr_save_cause_o        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .csr_mtval_o                    ( csr_mtval_o             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .priv_mode_i                    ( priv_mode_i             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .csr_mstatus_tw_i               ( csr_mstatus_tw_i        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      // Debug Signal</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .debug_mode_o                   ( debug_mode_o            ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .debug_cause_o                  ( debug_cause_o           ),</pre>
<pre style="margin:0; padding:0 ">      .debug_csr_save_o               ( debug_csr_save_o        ),</pre>
<pre style="margin:0; padding:0 ">      .debug_req_i                    ( debug_req_i             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .debug_single_step_i            ( debug_single_step_i     ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .debug_ebreakm_i                ( debug_ebreakm_i         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .debug_ebreaku_i                ( debug_ebreaku_i         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .trigger_match_i                ( trigger_match_i         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // stall signals</pre>
<pre style="margin:0; padding:0 ">      .lsu_req_in_id_i                ( lsu_req_in_id           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .stall_id_i                     ( stall_id                ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .stall_wb_i                     ( stall_wb                ),</pre>
<pre style="margin:0; padding:0 ">      .flush_id_o                     ( flush_id                ),</pre>
<pre style="margin:0; padding:0 ">      .ready_wb_i                     ( ready_wb_i              ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">      // Performance Counters</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .perf_jump_o                    ( perf_jump_o             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      .perf_tbranch_o                 ( perf_tbranch_o          )</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign multdiv_en_dec   = mult_en_dec | div_en_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign lsu_req         = instr_executing ? data_req_allowed & lsu_req_dec  : 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign mult_en_id      = instr_executing ? mult_en_dec                     : 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign div_en_id       = instr_executing ? div_en_dec                      : 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  assign lsu_req_o               = lsu_req;</pre>
<pre style="margin:0; padding:0 ">  assign lsu_we_o                = lsu_we;</pre>
<pre style="margin:0; padding:0 ">  assign lsu_type_o              = lsu_type;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign lsu_sign_ext_o          = lsu_sign_ext;</pre>
<pre style="margin:0; padding:0 ">  assign lsu_wdata_o             = rf_rdata_b_fwd;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  // csr_op_en_o is set when CSR access should actually happen.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  // csv_access_o is set when CSR access instruction is present and is used to compute whether a CSR</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  // access is illegal. A combinational loop would be created if csr_op_en_o was used along (as</pre>
<pre style="margin:0; padding:0 ">  // asserting it for an illegal csr access would result in a flush that would need to deassert it).</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign csr_op_en_o             = csr_access_o & instr_executing & instr_id_done_o;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  assign alu_operator_ex_o           = alu_operator;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign alu_operand_a_ex_o          = alu_operand_a;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign alu_operand_b_ex_o          = alu_operand_b;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign mult_en_ex_o                = mult_en_id;</pre>
<pre style="margin:0; padding:0 ">  assign div_en_ex_o                 = div_en_id;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  assign multdiv_operator_ex_o       = multdiv_operator;</pre>
<pre style="margin:0; padding:0 ">  assign multdiv_signed_mode_ex_o    = multdiv_signed_mode;</pre>
<pre style="margin:0; padding:0 ">  assign multdiv_operand_a_ex_o      = rf_rdata_a_fwd;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign multdiv_operand_b_ex_o      = rf_rdata_b_fwd;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  // Branch set control //</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  ////////////////////////</pre>
<pre id="id646" style="background-color: #FFB6C1; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  if (BranchTargetALU && !DataIndTiming) begin : g_branch_set_direct</pre>
<pre style="margin:0; padding:0 ">    // Branch set fed straight to controller with branch target ALU</pre>
<pre id="id649" style="background-color: #FFB6C1; margin:0; padding:0 ">    // (condition pass/fail used same cycle as generated instruction request)</pre>
<pre style="margin:0; padding:0 ">    assign branch_set      = branch_set_d;</pre>
<pre id="id651" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign branch_set_spec = branch_spec;</pre>
<pre id="id652" style="background-color: #FFB6C1; margin:0; padding:0 ">  end else begin : g_branch_set_flop</pre>
<pre id="id653" style="background-color: #FFB6C1; margin:0; padding:0 ">    // Branch set flopped without branch target ALU, or in fixed time execution mode</pre>
<pre id="id654" style="background-color: #FFB6C1; margin:0; padding:0 ">    // (condition pass/fail used next cycle where branch target is calculated)</pre>
<pre id="id655" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic branch_set_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="margin:0; padding:0 ">      if (!rst_ni) begin</pre>
<pre style="margin:0; padding:0 ">        branch_set_q <= 1'b0;</pre>
<pre style="margin:0; padding:0 ">      end else begin</pre>
<pre style="margin:0; padding:0 ">        branch_set_q <= branch_set_d;</pre>
<pre id="id662" style="background-color: #FFB6C1; margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre id="id664" style="background-color: #FFB6C1; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Branches always take two cycles in fixed time execution mode, with or without the branch</pre>
<pre style="margin:0; padding:0 ">    // target ALU (to avoid a path from the branch decision into the branch target ALU operand</pre>
<pre style="margin:0; padding:0 ">    // muxing).</pre>
<pre style="margin:0; padding:0 ">    assign branch_set      = (BranchTargetALU && !data_ind_timing_i) ? branch_set_d : branch_set_q;</pre>
<pre id="id669" style="background-color: #FFB6C1; margin:0; padding:0 ">    // Use the speculative branch signal when BTALU is enabled</pre>
<pre id="id670" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign branch_set_spec = (BranchTargetALU && !data_ind_timing_i) ? branch_spec : branch_set_q;</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre id="id672" style="background-color: #FFB6C1; margin:0; padding:0 "></pre>
<pre id="id673" style="background-color: #FFB6C1; margin:0; padding:0 ">  // Branch condition is calculated in the first cycle and flopped for use in the second cycle</pre>
<pre id="id674" style="background-color: #FFB6C1; margin:0; padding:0 ">  // (only used in fixed time execution mode to determine branch destination).</pre>
<pre id="id675" style="background-color: #FFB6C1; margin:0; padding:0 ">  if (DataIndTiming) begin : g_sec_branch_taken</pre>
<pre id="id676" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic branch_taken_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="margin:0; padding:0 ">      if (!rst_ni) begin</pre>
<pre id="id680" style="background-color: #FFB6C1; margin:0; padding:0 ">        branch_taken_q <= 1'b0;</pre>
<pre style="margin:0; padding:0 ">      end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        branch_taken_q <= branch_decision_i;</pre>
<pre style="margin:0; padding:0 ">      end</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    assign branch_taken = ~data_ind_timing_i | branch_taken_q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  end else begin : g_nosec_branch_taken</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Signal unused without fixed time execution mode - only taken branches will trigger branch_set</pre>
<pre style="margin:0; padding:0 ">    assign branch_taken = 1'b1;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Holding branch_set/jump_set high for more than one cycle may not cause a functional issue but</pre>
<pre style="margin:0; padding:0 ">  // could generate needless prefetch buffer flushes and instruction fetches. ID/EX is designed such</pre>
<pre style="margin:0; padding:0 ">  // that this shouldn't ever happen.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(NeverDoubleBranch, branch_set |=> ~branch_set)</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(NeverDoubleJump, jump_set |=> ~jump_set)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ///////////////</pre>
<pre style="margin:0; padding:0 ">  // ID-EX FSM //</pre>
<pre style="margin:0; padding:0 ">  ///////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  typedef enum logic { FIRST_CYCLE, MULTI_CYCLE } id_fsm_e;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  id_fsm_e id_fsm_q, id_fsm_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin : id_pipeline_reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      id_fsm_q            <= FIRST_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      id_fsm_q            <= id_fsm_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // ID/EX stage can be in two states, FIRST_CYCLE and MULTI_CYCLE. An instruction enters</pre>
<pre style="margin:0; padding:0 ">  // MULTI_CYCLE if it requires multiple cycles to complete regardless of stalls and other</pre>
<pre style="margin:0; padding:0 ">  // considerations. An instruction may be held in FIRST_CYCLE if it's unable to begin executing</pre>
<pre style="margin:0; padding:0 ">  // (this is controlled by instr_executing).</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    id_fsm_d                = id_fsm_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    rf_we_raw               = rf_we_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    stall_multdiv           = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    stall_jump              = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    stall_branch            = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    stall_alu               = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    branch_set_d            = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    branch_spec             = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    jump_set                = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    perf_branch_o           = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    if (instr_executing) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      unique case (id_fsm_q)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        FIRST_CYCLE: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          unique case (1'b1)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            lsu_req_dec: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              if (!WritebackStage) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                // LSU operation</pre>
<pre style="margin:0; padding:0 ">                id_fsm_d    = MULTI_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                if(~lsu_req_done_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                  id_fsm_d  = MULTI_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                end</pre>
<pre style="margin:0; padding:0 ">              end</pre>
<pre style="margin:0; padding:0 ">            end</pre>
<pre style="margin:0; padding:0 ">            multdiv_en_dec: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              // MUL or DIV operation</pre>
<pre style="margin:0; padding:0 ">              if (~ex_valid_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                // When single-cycle multiply is configured mul can finish in the first cycle so</pre>
<pre style="margin:0; padding:0 ">                // only enter MULTI_CYCLE state if a result isn't immediately available</pre>
<pre style="margin:0; padding:0 ">                id_fsm_d      = MULTI_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                rf_we_raw     = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                stall_multdiv = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              end</pre>
<pre style="margin:0; padding:0 ">            end</pre>
<pre style="margin:0; padding:0 ">            branch_in_dec: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              // cond branch operation</pre>
<pre style="margin:0; padding:0 ">              // All branches take two cycles in fixed time execution mode, regardless of branch</pre>
<pre style="margin:0; padding:0 ">              // condition.</pre>
<pre style="margin:0; padding:0 ">              id_fsm_d      = (data_ind_timing_i || (!BranchTargetALU && branch_decision_i)) ?</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                  MULTI_CYCLE : FIRST_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              stall_branch  = (~BranchTargetALU & branch_decision_i) | data_ind_timing_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              branch_set_d  = branch_decision_i | data_ind_timing_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              // Speculative branch (excludes branch_decision_i)</pre>
<pre style="margin:0; padding:0 ">              branch_spec   = SpecBranch ? 1'b1 : branch_decision_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              perf_branch_o = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            end</pre>
<pre style="margin:0; padding:0 ">            jump_in_dec: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              // uncond branch operation</pre>
<pre style="margin:0; padding:0 ">              // BTALU means jumps only need one cycle</pre>
<pre style="margin:0; padding:0 ">              id_fsm_d      = BranchTargetALU ? FIRST_CYCLE : MULTI_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              stall_jump    = ~BranchTargetALU;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              jump_set      = jump_set_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            end</pre>
<pre style="margin:0; padding:0 ">            alu_multicycle_dec: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              stall_alu     = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              id_fsm_d      = MULTI_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              rf_we_raw     = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            end</pre>
<pre style="margin:0; padding:0 ">            default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">              id_fsm_d      = FIRST_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            end</pre>
<pre style="margin:0; padding:0 ">          endcase</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        MULTI_CYCLE: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          if(multdiv_en_dec) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            rf_we_raw       = rf_we_dec & ex_valid_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">          if (multicycle_done & ready_wb_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            id_fsm_d        = FIRST_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            stall_multdiv   = multdiv_en_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            stall_branch    = branch_in_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">            stall_jump      = jump_in_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          end</pre>
<pre style="margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">        default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">          id_fsm_d          = FIRST_CYCLE;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">        end</pre>
<pre style="margin:0; padding:0 ">      endcase</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Note for the two-stage configuration ready_wb_i is always set</pre>
<pre style="margin:0; padding:0 ">  assign multdiv_ready_id_o = ready_wb_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  `ASSERT(StallIDIfMulticycle, (id_fsm_q == FIRST_CYCLE) & (id_fsm_d == MULTI_CYCLE) |-> stall_id)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Stall ID/EX stage for reason that relates to instruction in ID/EX</pre>
<pre style="margin:0; padding:0 ">  assign stall_id = stall_ld_hz | stall_mem | stall_multdiv | stall_jump | stall_branch |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                      stall_alu;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  assign instr_done = ~stall_id & ~flush_id & instr_executing;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  if (WritebackStage) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign multicycle_done = lsu_req_dec ? ~stall_mem : ex_valid_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  end else begin</pre>
<pre id="id822" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign multicycle_done = lsu_req_dec ? lsu_resp_valid_i : ex_valid_i;</pre>
<pre id="id823" style="background-color: #FFB6C1; margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Signal instruction in ID is in it's first cycle. It can remain in its</pre>
<pre style="margin:0; padding:0 ">  // first cycle if it is stalled.</pre>
<pre style="margin:0; padding:0 ">  assign instr_first_cycle      = instr_valid_i & (id_fsm_q == FIRST_CYCLE);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  // Used by RVFI to know when to capture register read data</pre>
<pre style="margin:0; padding:0 ">  // Used by ALU to access RS3 if ternary instruction.</pre>
<pre style="margin:0; padding:0 ">  assign instr_first_cycle_id_o = instr_first_cycle;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  if (WritebackStage) begin : gen_stall_mem</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    // Register read address matches write address in WB</pre>
<pre style="margin:0; padding:0 ">    logic rf_rd_a_wb_match;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic rf_rd_b_wb_match;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    // Hazard between registers being read and written</pre>
<pre style="margin:0; padding:0 ">    logic rf_rd_a_hz;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    logic rf_rd_b_hz;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    logic outstanding_memory_access;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    logic instr_kill;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Is a memory access ongoing that isn't finishing this cycle</pre>
<pre style="margin:0; padding:0 ">    assign outstanding_memory_access = (outstanding_load_wb_i | outstanding_store_wb_i) &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                       ~lsu_resp_valid_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Can start a new memory access if any previous one has finished or is finishing</pre>
<pre style="margin:0; padding:0 ">    assign data_req_allowed = ~outstanding_memory_access;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Instruction won't execute because:</pre>
<pre style="margin:0; padding:0 ">    // - There is a pending exception in writeback</pre>
<pre style="margin:0; padding:0 ">    //   The instruction in ID/EX will be flushed and the core will jump to an exception handler</pre>
<pre style="margin:0; padding:0 ">    // - The controller isn't running instructions</pre>
<pre style="margin:0; padding:0 ">    //   This either happens in preparation for a flush and jump to an exception handler e.g. in</pre>
<pre style="margin:0; padding:0 ">    //   response to an IRQ or debug request or whilst the core is sleeping or resetting/fetching</pre>
<pre style="margin:0; padding:0 ">    //   first instruction in which case any valid instruction in ID/EX should be ignored.</pre>
<pre style="margin:0; padding:0 ">    // - There was an error on instruction fetch</pre>
<pre style="margin:0; padding:0 ">    assign instr_kill = instr_fetch_err_i |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                        wb_exception      |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                        ~controller_run;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // With writeback stage instructions must be prevented from executing if there is:</pre>
<pre style="margin:0; padding:0 ">    // - A load hazard</pre>
<pre style="margin:0; padding:0 ">    // - A pending memory access</pre>
<pre style="margin:0; padding:0 ">    //   If it receives an error response this results in a precise exception from WB so ID/EX</pre>
<pre style="margin:0; padding:0 ">    //   instruction must not execute until error response is known).</pre>
<pre style="margin:0; padding:0 ">    // - A load/store error</pre>
<pre style="margin:0; padding:0 ">    //   This will cause a precise exception for the instruction in WB so ID/EX instruction must not</pre>
<pre style="margin:0; padding:0 ">    //   execute</pre>
<pre style="margin:0; padding:0 ">    assign instr_executing = instr_valid_i              &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                             ~instr_kill                &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                             ~stall_ld_hz               &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                             ~outstanding_memory_access;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    `ASSERT(IbexStallIfValidInstrNotExecuting,</pre>
<pre style="margin:0; padding:0 ">      instr_valid_i & ~instr_kill & ~instr_executing |-> stall_id)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Stall for reasons related to memory:</pre>
<pre style="margin:0; padding:0 ">    // * There is an outstanding memory access that won't resolve this cycle (need to wait to allow</pre>
<pre style="margin:0; padding:0 ">    //   precise exceptions)</pre>
<pre style="margin:0; padding:0 ">    // * There is a load/store request not being granted or which is unaligned and waiting to issue</pre>
<pre style="margin:0; padding:0 ">    //   a second request (needs to stay in ID for the address calculation)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign stall_mem = instr_valid_i & (outstanding_memory_access | (lsu_req_dec & ~lsu_req_done_i));</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // If we stall a load in ID for any reason, it must not make an LSU request</pre>
<pre style="margin:0; padding:0 ">    // (otherwide we might issue two requests for the same instruction)</pre>
<pre style="margin:0; padding:0 ">    `ASSERT(IbexStallMemNoRequest,</pre>
<pre style="margin:0; padding:0 ">      instr_valid_i & lsu_req_dec & ~instr_done |-> ~lsu_req_done_i)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Indicate to the controller that an lsu req is in ID stage - we cannot handle interrupts or</pre>
<pre style="margin:0; padding:0 ">    // debug requests until the load/store completes</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign lsu_req_in_id = instr_valid_i & lsu_req_dec;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_rd_a_wb_match = (rf_waddr_wb_i == rf_raddr_a_o) & |rf_raddr_a_o;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_rd_b_wb_match = (rf_waddr_wb_i == rf_raddr_b_o) & |rf_raddr_b_o;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // If instruction is reading register that load will be writing stall in</pre>
<pre style="margin:0; padding:0 ">    // ID until load is complete. No need to stall when reading zero register.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_rd_a_hz = rf_rd_a_wb_match & rf_ren_a;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_rd_b_hz = rf_rd_b_wb_match & rf_ren_b;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // If instruction is read register that writeback is writing forward writeback data to read</pre>
<pre style="margin:0; padding:0 ">    // data. Note this doesn't factor in load data as it arrives too late, such hazards are</pre>
<pre style="margin:0; padding:0 ">    // resolved via a stall (see above).</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_rdata_a_fwd = rf_rd_a_wb_match & rf_write_wb_i ? rf_wdata_fwd_wb_i : rf_rdata_a_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign rf_rdata_b_fwd = rf_rd_b_wb_match & rf_write_wb_i ? rf_wdata_fwd_wb_i : rf_rdata_b_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign stall_ld_hz = outstanding_load_wb_i & (rf_rd_a_hz | rf_rd_b_hz);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign instr_type_wb_o = ~lsu_req_dec ? WB_INSTR_OTHER :</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                              lsu_we      ? WB_INSTR_STORE :</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                            WB_INSTR_LOAD;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign en_wb_o = instr_done;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign instr_id_done_o = en_wb_o & ready_wb_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Stall ID/EX as instruction in ID/EX cannot proceed to writeback yet</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign stall_wb = en_wb_o & ~ready_wb_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    assign perf_dside_wait_o = instr_valid_i & ~instr_kill & (outstanding_memory_access | stall_ld_hz);</pre>
<pre id="id923" style="background-color: #FFB6C1; margin:0; padding:0 ">  end else begin</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id925" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign data_req_allowed = instr_first_cycle;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Without Writeback Stage always stall the first cycle of a load/store.</pre>
<pre style="margin:0; padding:0 ">    // Then stall until it is complete</pre>
<pre id="id929" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign stall_mem = instr_valid_i & (lsu_req_dec & (~lsu_resp_valid_i | instr_first_cycle));</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // No load hazards without Writeback Stage</pre>
<pre id="id932" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign stall_ld_hz   = 1'b0;</pre>
<pre id="id933" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign lsu_req_in_id = 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Without writeback stage any valid instruction that hasn't seen an error will execute</pre>
<pre id="id936" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign instr_executing = instr_valid_i & ~instr_fetch_err_i & controller_run;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    `ASSERT(IbexStallIfValidInstrNotExecuting,</pre>
<pre style="margin:0; padding:0 ">      instr_valid_i & ~instr_fetch_err_i & ~instr_executing & controller_run |-> stall_id)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // No data forwarding without writeback stage so always take source register data direct from</pre>
<pre style="margin:0; padding:0 ">    // register file</pre>
<pre id="id943" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign rf_rdata_a_fwd = rf_rdata_a_i;</pre>
<pre id="id944" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign rf_rdata_b_fwd = rf_rdata_b_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // Unused Writeback stage only IO & wiring</pre>
<pre style="margin:0; padding:0 ">    // Assign inputs and internal wiring to unused signals to satisfy lint checks</pre>
<pre style="margin:0; padding:0 ">    // Tie-off outputs to constant values</pre>
<pre id="id949" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic unused_data_req_done_ex;</pre>
<pre id="id950" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic unused_lsu_load;</pre>
<pre id="id951" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic [4:0] unused_rf_waddr_wb;</pre>
<pre id="id952" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic unused_rf_write_wb;</pre>
<pre id="id953" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic unused_outstanding_load_wb;</pre>
<pre id="id954" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic unused_outstanding_store_wb;</pre>
<pre id="id955" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic unused_wb_exception;</pre>
<pre id="id956" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic unused_rf_ren_a, unused_rf_ren_b;</pre>
<pre id="id957" style="background-color: #FFB6C1; margin:0; padding:0 ">    logic [31:0] unused_rf_wdata_fwd_wb;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id959" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_data_req_done_ex     = lsu_req_done_i;</pre>
<pre id="id960" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_rf_waddr_wb          = rf_waddr_wb_i;</pre>
<pre id="id961" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_rf_write_wb          = rf_write_wb_i;</pre>
<pre id="id962" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_outstanding_load_wb  = outstanding_load_wb_i;</pre>
<pre id="id963" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_outstanding_store_wb = outstanding_store_wb_i;</pre>
<pre id="id964" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_wb_exception         = wb_exception;</pre>
<pre id="id965" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_rf_ren_a             = rf_ren_a;</pre>
<pre id="id966" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_rf_ren_b             = rf_ren_b;</pre>
<pre id="id967" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign unused_rf_wdata_fwd_wb      = rf_wdata_fwd_wb_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id969" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign instr_type_wb_o = WB_INSTR_OTHER;</pre>
<pre id="id970" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign stall_wb        = 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id972" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign perf_dside_wait_o = instr_executing & lsu_req_dec & ~lsu_resp_valid_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id974" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign en_wb_o         = 1'b0;</pre>
<pre id="id975" style="background-color: #FFB6C1; margin:0; padding:0 ">    assign instr_id_done_o = instr_done;</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign perf_mul_wait_o = stall_multdiv & mult_en_dec;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign perf_div_wait_o = stall_multdiv & div_en_dec;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign instr_id_done_compressed_o = instr_id_done_o & instr_is_compressed_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  ////////////////</pre>
<pre style="margin:0; padding:0 ">  // Assertions //</pre>
<pre style="margin:0; padding:0 ">  ////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Selectors must be known/valid.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN_IF(IbexAluOpMuxSelKnown, alu_op_a_mux_sel, instr_valid_i)</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexAluAOpMuxSelValid, instr_valid_i |-> alu_op_a_mux_sel inside {</pre>
<pre style="margin:0; padding:0 ">      OP_A_REG_A,</pre>
<pre style="margin:0; padding:0 ">      OP_A_FWD,</pre>
<pre style="margin:0; padding:0 ">      OP_A_CURRPC,</pre>
<pre style="margin:0; padding:0 ">      OP_A_IMM})</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN_IF(IbexBTAluAOpMuxSelKnown, bt_a_mux_sel, instr_valid_i)</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexBTAluAOpMuxSelValid, instr_valid_i |-> bt_a_mux_sel inside {</pre>
<pre style="margin:0; padding:0 ">      OP_A_REG_A,</pre>
<pre style="margin:0; padding:0 ">      OP_A_CURRPC})</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN_IF(IbexBTAluBOpMuxSelKnown, bt_b_mux_sel, instr_valid_i)</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexBTAluBOpMuxSelValid, instr_valid_i |-> bt_b_mux_sel inside {</pre>
<pre style="margin:0; padding:0 ">      IMM_B_I,</pre>
<pre style="margin:0; padding:0 ">      IMM_B_B,</pre>
<pre style="margin:0; padding:0 ">      IMM_B_J,</pre>
<pre style="margin:0; padding:0 ">      IMM_B_INCR_PC})</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexRegfileWdataSelValid, instr_valid_i |-> rf_wdata_sel inside {</pre>
<pre style="margin:0; padding:0 ">      RF_WD_EX,</pre>
<pre style="margin:0; padding:0 ">      RF_WD_CSR})</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IbexWbStateKnown, id_fsm_q)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Branch decision must be valid when jumping.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN_IF(IbexBranchDecisionValid, branch_decision_i,</pre>
<pre style="margin:0; padding:0 ">      instr_valid_i && !(illegal_csr_insn_i || instr_fetch_err_i))</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Instruction delivered to ID stage can not contain X.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN_IF(IbexIdInstrKnown, instr_rdata_i,</pre>
<pre style="margin:0; padding:0 ">      instr_valid_i && !(illegal_c_insn_i || instr_fetch_err_i))</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Instruction delivered to ID stage can not contain X.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN_IF(IbexIdInstrALUKnown, instr_rdata_alu_i,</pre>
<pre style="margin:0; padding:0 ">      instr_valid_i && !(illegal_c_insn_i || instr_fetch_err_i))</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Multicycle enable signals must be unique.</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexMulticycleEnableUnique,</pre>
<pre style="margin:0; padding:0 ">      $onehot0({lsu_req_dec, multdiv_en_dec, branch_in_dec, jump_in_dec}))</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Duplicated instruction flops must match</pre>
<pre style="margin:0; padding:0 ">  // === as DV environment can produce instructions with Xs in, so must use precise match that</pre>
<pre style="margin:0; padding:0 ">  // includes Xs</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexDuplicateInstrMatch, instr_valid_i |-> instr_rdata_i === instr_rdata_alu_i)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  `ifdef CHECK_MISALIGNED</pre>
<pre style="margin:0; padding:0 ">  `ASSERT(IbexMisalignedMemoryAccess, !lsu_addr_incr_req_i)</pre>
<pre style="margin:0; padding:0 ">  `endif</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">endmodule</pre>
<pre style="margin:0; padding:0 "></pre>
</body>
</html>
