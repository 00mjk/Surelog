
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>../src/lowrisc_ip_spi_device_0.1/rtl/spi_device.sv Cov: 97% </h3>
<pre style="margin:0; padding:0 ">// Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">// Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">// SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 ">//</pre>
<pre style="margin:0; padding:0 ">// Serial Peripheral Interface (SPI) Device module.</pre>
<pre style="margin:0; padding:0 ">//</pre>
<pre style="margin:0; padding:0 ">//</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">`include "prim_assert.sv"</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">module spi_device #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  parameter int SramAw = 9, // 2kB, SRAM Width is DW</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  parameter int SramDw = 32</pre>
<pre style="margin:0; padding:0 ">) (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Register interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input  tlul_pkg::tl_h2d_t tl_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output tlul_pkg::tl_d2h_t tl_o,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // SPI Interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input              cio_sck_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input              cio_csb_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic       cio_miso_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic       cio_miso_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input              cio_mosi_i,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Interrupts</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic intr_rxf_o,         // RX FIFO Full</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic intr_rxlvl_o,       // RX FIFO above level</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic intr_txlvl_o,       // TX FIFO below level</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic intr_rxerr_o,       // RX Frame error</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic intr_rxoverflow_o,  // RX Async FIFO Overflow</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  output logic intr_txunderflow_o, // TX Async FIFO Underflow</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  input scanmode_i</pre>
<pre id="id38" style="background-color: #FFB6C1; margin:0; padding:0 ">);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  import spi_device_pkg::*;</pre>
<pre id="id41" style="background-color: #FFB6C1; margin:0; padding:0 ">  import spi_device_reg_pkg::*;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int FifoWidth = $bits(spi_byte_t);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int FifoDepth = 8; // 2 DWords</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int SDW = $clog2(SramDw/FifoWidth);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int PtrW = SramAw + 1 + SDW;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  localparam int AsFifoDepthW = $clog2(FifoDepth+1);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic clk_spi_in;   // clock for latch MOSI</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic clk_spi_out;  // clock for driving MISO</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_device_reg2hw_t reg2hw;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_device_hw2reg_t hw2reg;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  tlul_pkg::tl_h2d_t tl_sram_h2d [1];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  tlul_pkg::tl_d2h_t tl_sram_d2h [1];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Dual-port SRAM Interface: Refer prim_ram_2p_wrapper.sv</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic              mem_a_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic              mem_a_write;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramAw-1:0] mem_a_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramDw-1:0] mem_a_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic              mem_a_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramDw-1:0] mem_a_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [1:0]        mem_a_rerror;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic              mem_b_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic              mem_b_write;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramAw-1:0] mem_b_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramDw-1:0] mem_b_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic              mem_b_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramDw-1:0] mem_b_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [1:0]        mem_b_rerror;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////////////</pre>
<pre style="margin:0; padding:0 ">  // Control signals //</pre>
<pre style="margin:0; padding:0 ">  /////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic cpol; // Clock polarity</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic cpha; // Phase : Not complete</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic txorder; // TX bitstream order: 0(bit 7 to 0), 1(bit 0 to 7)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic rxorder; // RX bitstream order: 0(bit 7 to 0), 1(bit 0 to 7)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic abort;  // Abort current operations (txf only at this time)</pre>
<pre style="margin:0; padding:0 ">                // Think how FW knows abort is done.</pre>
<pre style="margin:0; padding:0 ">  //logic abort_done; // TODO: Not implemented yet</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic csb_syncd;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic rst_txfifo_n, rst_rxfifo_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic rst_txfifo_reg, rst_rxfifo_reg;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre id="id93" style="background-color: #FFB6C1; margin:0; padding:0 ">  //spi_addr_size_e addr_size; // Not used in fwmode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_mode_e spi_mode;</pre>
<pre style="margin:0; padding:0 ">  //spi_byte_t fw_dummy_byte;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  logic intr_sram_rxf_full, intr_fwm_rxerr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic intr_fwm_rxlvl, rxlvl, rxlvl_d, intr_fwm_txlvl, txlvl, txlvl_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic intr_fwm_rxoverflow, intr_fwm_txunderflow;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // RX Async FIFO Signals</pre>
<pre style="margin:0; padding:0 ">  //  Write: SCK positive edge</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic      rxf_wvalid, rxf_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_byte_t rxf_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic      rxf_overflow;</pre>
<pre style="margin:0; padding:0 ">  //  Read: Main clock</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic      rxf_rvalid, rxf_rready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_byte_t rxf_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic      rxf_full_syncd;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // TX Async FIFO Signals</pre>
<pre style="margin:0; padding:0 ">  //   Read: SCK negative edge</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic      txf_rvalid, txf_rready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_byte_t txf_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic      txf_underflow;</pre>
<pre style="margin:0; padding:0 ">  //   Write: Main clock</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic      txf_wvalid, txf_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_byte_t txf_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic      txf_empty_syncd;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // SRAM FIFO control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  typedef enum int {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    FwModeRxFifo = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    FwModeTxFifo = 1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  } fwm_fifo_e;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        [7:0] timer_v;   // Wait timer inside rxf control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic   [PtrW-1:0] sram_rxf_rptr, sram_rxf_wptr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic   [PtrW-1:0] sram_txf_rptr, sram_txf_wptr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic   [PtrW-1:0] sram_rxf_depth, sram_txf_depth;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramAw-1:0] sram_rxf_bindex, sram_txf_bindex;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramAw-1:0] sram_rxf_lindex, sram_txf_lindex;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        [1:0] fwm_sram_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramAw-1:0] fwm_sram_addr  [2];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic              fwm_sram_write [2];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramDw-1:0] fwm_sram_wdata [2];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        [1:0] fwm_sram_gnt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        [1:0] fwm_sram_rvalid;    // RXF doesn't use</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [SramDw-1:0] fwm_sram_rdata [2]; // RXF doesn't use</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic        [1:0] fwm_sram_error [2];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic [AsFifoDepthW-1:0] as_txfifo_depth, as_rxfifo_depth;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  //////////////////////////////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 ">  // Connect phase (between control signals above and register module //</pre>
<pre style="margin:0; padding:0 ">  //////////////////////////////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign cpol = reg2hw.cfg.cpol.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign cpha = reg2hw.cfg.cpha.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign txorder = reg2hw.cfg.tx_order.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rxorder = reg2hw.cfg.rx_order.q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rst_txfifo_reg = reg2hw.control.rst_txfifo.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rst_rxfifo_reg = reg2hw.control.rst_rxfifo.q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign timer_v = reg2hw.cfg.timer_v.q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign sram_rxf_bindex = reg2hw.rxf_addr.base.q[SDW+:SramAw];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign sram_rxf_lindex = reg2hw.rxf_addr.limit.q[SDW+:SramAw];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign sram_txf_bindex = reg2hw.txf_addr.base.q[SDW+:SramAw];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign sram_txf_lindex = reg2hw.txf_addr.limit.q[SDW+:SramAw];</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign sram_rxf_rptr = reg2hw.rxf_ptr.rptr.q[PtrW-1:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.rxf_ptr.wptr.d = {{(16-PtrW){1'b0}}, sram_rxf_wptr};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.rxf_ptr.wptr.de = 1'b1;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign sram_txf_wptr = reg2hw.txf_ptr.wptr.q[PtrW-1:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.txf_ptr.rptr.d = {{(16-PtrW){1'b0}}, sram_txf_rptr};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.txf_ptr.rptr.de = 1'b1;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign abort = reg2hw.control.abort.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.status.abort_done.d  = 1'b1;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.status.rxf_empty.d = ~rxf_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.status.txf_full.d  = ~txf_wready;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // SYNC logic required</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.status.rxf_full.d = rxf_full_syncd;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.status.txf_empty.d = txf_empty_syncd;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // CSb : after 2stage synchronizer</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.status.csb.d = csb_syncd;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_flop_2sync #(.Width(1)) u_sync_csb (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .d(cio_csb_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .q(csb_syncd)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic rxf_full_q, txf_empty_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_spi_in or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) rxf_full_q <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    else         rxf_full_q <= ~rxf_wready;</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_spi_out or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) txf_empty_q <= 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    else         txf_empty_q <= ~txf_rvalid;</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_flop_2sync #(.Width(1)) u_sync_rxf (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .d(rxf_full_q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .q(rxf_full_syncd)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_flop_2sync #(.Width(1), .ResetValue(1'b1)) u_sync_txe (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .d(txf_empty_q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .q(txf_empty_syncd)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign spi_mode = spi_mode_e'(reg2hw.control.mode.q);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Async FIFO level</pre>
<pre style="margin:0; padding:0 ">  //  rx rdepth, tx wdepth to be in main clock domain</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.async_fifo_level.txlvl.d  = {{(8-AsFifoDepthW){1'b0}}, as_txfifo_depth};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.async_fifo_level.rxlvl.d  = {{(8-AsFifoDepthW){1'b0}}, as_rxfifo_depth};</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Interrupt</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Edge</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic sram_rxf_full_q, fwm_rxerr_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic sram_rxf_full  , fwm_rxerr  ;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // TODO: Check if CE# deasserted in the middle of bit transfer</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign fwm_rxerr = 1'b0;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      sram_rxf_full_q <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      fwm_rxerr_q     <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      sram_rxf_full_q <= sram_rxf_full;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      fwm_rxerr_q     <= fwm_rxerr;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Interrupt</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_sram_rxf_full = ~sram_rxf_full_q & sram_rxf_full;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_fwm_rxerr     = ~fwm_rxerr_q & fwm_rxerr;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rxlvl_d = (sram_rxf_depth >= reg2hw.fifo_level.rxlvl.q[PtrW-1:0]) ;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign txlvl_d = (sram_txf_depth <  reg2hw.fifo_level.txlvl.q[PtrW-1:0]) ;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      rxlvl <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      txlvl <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      rxlvl <= rxlvl_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      txlvl <= txlvl_d;</pre>
<pre style="margin:0; padding:0 ">    end</pre>
<pre style="margin:0; padding:0 ">  end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_fwm_rxlvl = ~rxlvl && rxlvl_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_fwm_txlvl = ~txlvl && txlvl_d;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // rxf_overflow</pre>
<pre style="margin:0; padding:0 ">  //    Could trigger lint error for input clock.</pre>
<pre style="margin:0; padding:0 ">  //    It's unavoidable due to the characteristics of SPI intf</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_pulse_sync u_rxf_overflow (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_src_i   (clk_spi_in         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_src_ni  (rst_ni             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .src_pulse_i (rxf_overflow       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_dst_i   (clk_i              ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_dst_ni  (rst_ni             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .dst_pulse_o (intr_fwm_rxoverflow)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // txf_underflow</pre>
<pre style="margin:0; padding:0 ">  //    Could trigger lint error for input clock.</pre>
<pre style="margin:0; padding:0 ">  //    It's unavoidable due to the characteristics of SPI intf</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_pulse_sync u_txf_underflow (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_src_i   (clk_spi_out         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_src_ni  (rst_ni              ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .src_pulse_i (txf_underflow       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_dst_i   (clk_i               ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_dst_ni  (rst_ni              ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .dst_pulse_o (intr_fwm_txunderflow)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_rxlvl_o       = reg2hw.intr_enable.rxlvl.q       & reg2hw.intr_state.rxlvl.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_txlvl_o       = reg2hw.intr_enable.txlvl.q       & reg2hw.intr_state.txlvl.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_rxf_o         = reg2hw.intr_enable.rxf.q         & reg2hw.intr_state.rxf.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_rxerr_o       = reg2hw.intr_enable.rxerr.q       & reg2hw.intr_state.rxerr.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_rxoverflow_o  = reg2hw.intr_enable.rxoverflow.q  & reg2hw.intr_state.rxoverflow.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign intr_txunderflow_o = reg2hw.intr_enable.txunderflow.q & reg2hw.intr_state.txunderflow.q;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.rxf.d    = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.rxf.de   = intr_sram_rxf_full |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                      (reg2hw.intr_test.rxf.qe   & reg2hw.intr_test.rxf.q);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.rxerr.d  = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.rxerr.de = intr_fwm_rxerr |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                      (reg2hw.intr_test.rxerr.qe & reg2hw.intr_test.rxerr.q);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.rxlvl.d  = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.rxlvl.de = intr_fwm_rxlvl |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                      (reg2hw.intr_test.rxlvl.qe & reg2hw.intr_test.rxlvl.q);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.txlvl.d  = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.txlvl.de = intr_fwm_txlvl |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">                                      (reg2hw.intr_test.txlvl.qe & reg2hw.intr_test.txlvl.q);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.rxoverflow.d   = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.rxoverflow.de  = intr_fwm_rxoverflow |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      (reg2hw.intr_test.rxoverflow.qe  & reg2hw.intr_test.rxoverflow.q);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.txunderflow.d  = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign hw2reg.intr_state.txunderflow.de = intr_fwm_txunderflow |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">      (reg2hw.intr_test.txunderflow.qe & reg2hw.intr_test.txunderflow.q);</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  //////////////////////////////</pre>
<pre style="margin:0; padding:0 ">  // // Clock & reset control //</pre>
<pre style="margin:0; padding:0 ">  //////////////////////////////</pre>
<pre style="margin:0; padding:0 ">  //  clk_spi cannot use glitch-free clock mux as clock switching in glitch-free</pre>
<pre style="margin:0; padding:0 ">  //  requires two clocks to propagate clock selection and enable but SPI clock</pre>
<pre style="margin:0; padding:0 ">  //  doesn't exist until it transmits data through MOSI</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic sck_n;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  logic rst_spi_n;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_clock_inverter u_clk_spi (.clk_i(cio_sck_i), .clk_no(sck_n), .scanmode_i);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign clk_spi_in  = (cpha ^ cpol) ? sck_n    : cio_sck_i   ;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign clk_spi_out = (cpha ^ cpol) ? cio_sck_i    : sck_n   ;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rst_spi_n = (scanmode_i) ? rst_ni : rst_ni & ~cio_csb_i;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rst_txfifo_n = (scanmode_i) ? rst_ni : rst_ni & ~rst_txfifo_reg;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  assign rst_rxfifo_n = (scanmode_i) ? rst_ni : rst_ni & ~rst_rxfifo_reg;</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="margin:0; padding:0 ">  // FW Mode //</pre>
<pre style="margin:0; padding:0 ">  /////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_fwmode u_fwmode (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_in_i     (clk_spi_in),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_in_ni    (rst_spi_n),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_out_i    (clk_spi_out),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_out_ni   (rst_spi_n),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .cpha_i        (cpha),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .cfg_rxorder_i (rxorder),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .cfg_txorder_i (txorder),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .mode_i        (spi_mode),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rx_wvalid_o   (rxf_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rx_wready_i   (rxf_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rx_data_o     (rxf_wdata),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tx_rvalid_i   (txf_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tx_rready_o   (txf_rready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tx_data_i     (txf_rdata),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rx_overflow_o  (rxf_overflow),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tx_underflow_o (txf_underflow),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">    // SPI signal</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .csb_i         (cio_csb_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .mosi          (cio_mosi_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .miso          (cio_miso_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .miso_oe       (cio_miso_en_o)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // FIFO: Connecting FwMode to SRAM CTRLs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_fifo_async #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Width (FifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Depth (FifoDepth)</pre>
<pre id="id365" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) u_rx_fifo (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_wr_i     (clk_spi_in),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_wr_ni    (rst_rxfifo_n),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_rd_i     (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_rd_ni    (rst_rxfifo_n),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wvalid       (rxf_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wready       (rxf_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wdata        (rxf_wdata),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rvalid       (rxf_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rready       (rxf_rready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rdata        (rxf_rdata),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wdepth       (),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rdepth       (as_rxfifo_depth)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_fifo_async #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Width (FifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Depth (FifoDepth)</pre>
<pre id="id387" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) u_tx_fifo (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_wr_i     (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_wr_ni    (rst_txfifo_n),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_rd_i     (clk_spi_out),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_rd_ni    (rst_txfifo_n),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wvalid       (txf_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wready       (txf_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wdata        (txf_wdata),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rvalid       (txf_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rready       (txf_rready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rdata        (txf_rdata),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wdepth       (as_txfifo_depth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rdepth       ()</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // RX Fifo control (FIFO Read port --> SRAM request)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_fwm_rxf_ctrl #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .FifoDw (FifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .SramAw (SramAw),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .SramDw (SramDw)</pre>
<pre id="id411" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) u_rxf_ctrl (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .base_index_i  (sram_rxf_bindex),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .limit_index_i (sram_rxf_lindex),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .timer_v      (timer_v),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rptr         (sram_rxf_rptr),  // Given by FW</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wptr         (sram_rxf_wptr),  // to Register interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .depth        (sram_rxf_depth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .full         (sram_rxf_full),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .fifo_valid  (rxf_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .fifo_ready  (rxf_rready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .fifo_rdata  (rxf_rdata),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_req    (fwm_sram_req   [FwModeRxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_write  (fwm_sram_write [FwModeRxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_addr   (fwm_sram_addr  [FwModeRxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_wdata  (fwm_sram_wdata [FwModeRxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_gnt    (fwm_sram_gnt   [FwModeRxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_rvalid (fwm_sram_rvalid[FwModeRxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_rdata  (fwm_sram_rdata [FwModeRxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_error  (fwm_sram_error [FwModeRxFifo])</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // TX Fifo control (SRAM read request --> FIFO write)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_fwm_txf_ctrl #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .FifoDw (FifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .SramAw (SramAw),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .SramDw (SramDw)</pre>
<pre id="id442" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) u_txf_ctrl (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .base_index_i  (sram_txf_bindex),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .limit_index_i (sram_txf_lindex),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .abort        (abort),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rptr         (sram_txf_rptr),  // Given by FW</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wptr         (sram_txf_wptr),  // to Register interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .depth        (sram_txf_depth),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .fifo_valid  (txf_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .fifo_ready  (txf_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .fifo_wdata  (txf_wdata),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_req    (fwm_sram_req   [FwModeTxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_write  (fwm_sram_write [FwModeTxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_addr   (fwm_sram_addr  [FwModeTxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_wdata  (fwm_sram_wdata [FwModeTxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_gnt    (fwm_sram_gnt   [FwModeTxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_rvalid (fwm_sram_rvalid[FwModeTxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_rdata  (fwm_sram_rdata [FwModeTxFifo]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_error  (fwm_sram_error [FwModeTxFifo])</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Arbiter for FIFOs : Connecting between SRAM Ctrls and SRAM interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_sram_arbiter #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .N       (2),  // RXF, TXF</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .SramDw (SramDw),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .SramAw (SramAw)   // 2kB</pre>
<pre id="id473" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) u_fwmode_arb (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .req          (fwm_sram_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .req_addr     (fwm_sram_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .req_write    (fwm_sram_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .req_wdata    (fwm_sram_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .gnt          (fwm_sram_gnt),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rsp_rvalid   (fwm_sram_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rsp_rdata    (fwm_sram_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rsp_error    (fwm_sram_error),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_req     (mem_b_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_addr    (mem_b_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_write   (mem_b_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_wdata   (mem_b_wdata),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_rvalid  (mem_b_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_rdata   (mem_b_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .sram_rerror  (mem_b_rerror)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  tlul_adapter_sram #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .SramAw      (SramAw),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .SramDw      (SramDw),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Outstanding (1),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .ByteAccess  (0)</pre>
<pre id="id502" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) u_tlul2sram (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tl_i (tl_sram_h2d [0]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tl_o (tl_sram_d2h [0]),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .req_o    (mem_a_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .gnt_i    (mem_a_req),  //Always grant when request</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .we_o     (mem_a_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .addr_o   (mem_a_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wdata_o  (mem_a_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .wmask_o  (),           // Not used</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rdata_i  (mem_a_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rvalid_i (mem_a_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rerror_i (mem_a_rerror)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // SRAM Wrapper</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  prim_ram_2p_adv #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Depth (512),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .Width (SramDw),    // 32 x 512 --> 2kB</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .DataBitsPerMask (1),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .CfgW  (8),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .EnableECC           (1),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .EnableParity        (0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .EnableInputPipeline (0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .EnableOutputPipeline(0)</pre>
<pre id="id531" style="background-color: #FFB6C1; margin:0; padding:0 ">  ) u_memory_2p (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .a_req_i    (mem_a_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .a_write_i  (mem_a_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .a_addr_i   (mem_a_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .a_wdata_i  (mem_a_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .a_wmask_i  ({SramDw{1'b1}}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .a_rvalid_o (mem_a_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .a_rdata_o  (mem_a_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .a_rerror_o (mem_a_rerror),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .b_req_i    (mem_b_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .b_write_i  (mem_b_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .b_addr_i   (mem_b_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .b_wdata_i  (mem_b_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .b_wmask_i  ({SramDw{1'b1}}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .b_rvalid_o (mem_b_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .b_rdata_o  (mem_b_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .b_rerror_o (mem_b_rerror),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .cfg_i      ('0)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // Register module</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  spi_device_reg_top u_reg (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .rst_ni,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tl_i (tl_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tl_o (tl_o),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tl_win_o (tl_sram_h2d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .tl_win_i (tl_sram_d2h),</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .reg2hw,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .hw2reg,</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">    .devmode_i  (1'b1)</pre>
<pre style="margin:0; padding:0 ">  );</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  // make sure scanmode_i is never X (including during reset)</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(scanmodeKnown, scanmode_i, clk_i, 0)</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(CioMisoEnOKnown, cio_miso_en_o)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IntrRxfOKnown,         intr_rxf_o        )</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IntrRxlvlOKnown,       intr_rxlvl_o      )</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IntrTxlvlOKnown,       intr_txlvl_o      )</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IntrRxerrOKnown,       intr_rxerr_o      )</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IntrRxoverflowOKnown,  intr_rxoverflow_o )</pre>
<pre style="margin:0; padding:0 ">  `ASSERT_KNOWN(IntrTxunderflowOKnown, intr_txunderflow_o)</pre>
<pre style="margin:0; padding:0 "></pre>
<pre style="margin:0; padding:0 ">endmodule</pre>
<pre style="margin:0; padding:0 "></pre>
</body>
</html>
